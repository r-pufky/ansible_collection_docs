{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Purpose","text":""},{"location":"#purpose","title":"Purpose","text":"<p>Ansible development documentation and standards for collection and role development. Intended for developer use only. All collections published at https://galaxy.ansible.com/ui/namespaces/r_pufky follow these guidelines.</p> <p>Ansible</p> <p>Test Environments</p> <p>Docstring</p>"},{"location":"ansible/troubleshooting/","title":"Troubleshooting","text":""},{"location":"ansible/troubleshooting/#troubleshooting","title":"Troubleshooting","text":""},{"location":"ansible/troubleshooting/#remove-submodule","title":"Remove Submodule","text":"<p>Usually after a bad initial creation or weird sync state.</p> <p>Remove from collection root </p><pre><code>rm -rfv roles/{ROLE}\ngit rm -r roles/{ROLE}\nrm -rf .git/modules/roles/{ROLE}\ngit config --remove-section submodule.roles/{ROLE}</code></pre><p></p> <p>Submodule is fully removed and ready to be re-added.</p> <p>Reference:</p> <ul> <li>https://stackoverflow.com/questions/1260748/how-do-i-remove-a-submodule</li> </ul>"},{"location":"ansible/troubleshooting/#multiple-configurations-found-for-submodulerolesrole","title":"Multiple configurations found for 'submodule.roles/{ROLE}'","text":"<p>.git/config mis-match against checked in submodules file .gitmodules.</p> Error <p>warning: {HASH}:.gitmodules, multiple configurations found for 'submodule.roles/{ROLE}'. Skipping second one!</p> <p>Ensure files are the same Check both .git/config and .gitmodules are up to date and the same. Add to git commit if needed.</p> <p>Reference:</p> <ul> <li>https://stackoverflow.com/questions/51883100/git-submodule-warning-multiple-configurations-found</li> </ul>"},{"location":"ansible/troubleshooting/#no_log-does-not-honor-variable","title":"no_log does not honor variable","text":"<p><code>no_log</code> currently does not honor variable interpretation.</p> <p>Use <code>loop_control</code> whenever possible or statically set <code>no_log: true</code> </p><pre><code>- name: 'looping task with passwords'\n  ansible.builtin.include_tasks: 'some_task.yml'\n  loop: '{{ user_accounts }}'\n  loop_control:  # Preferred - provides execution context.\n    label: '{{ item.user }}'\n\n- name: 'looping task with passwords'\n  ansible.builtin.include_tasks: 'some_task.yml'\n  no_log: true  # Strips all debugging feedback.</code></pre> Reference:<p></p> <ul> <li>https://github.com/ansible/ansible/issues/83323#issuecomment-2686201726</li> </ul>"},{"location":"ansible/collection/","title":"Collection Development","text":""},{"location":"ansible/collection/#collection-development","title":"Collection Development","text":"<p>Prerequisites</p> <ul> <li>Ansible Environment.</li> <li>VirtualBox.</li> </ul>"},{"location":"ansible/collection/#create-new-collection","title":"Create New Collection","text":"<p>Create new repository with minimal ansible environment </p><pre><code>git clone https://github.com/{USER}/{REPO} /var/git/{REPO}\ncd ~/git/{REPO}</code></pre><p></p>"},{"location":"ansible/collection/#update-ansible-environment","title":"Update Ansible Environment","text":"<p>A minimal (clean) environment is provided to test collection and roles against a vanilla ansible installation - enforcing only settings which make testing easier.</p> <p>ansible.env (1)</p> <ol> <li>0644 {USER}:{USER}</li> </ol> <pre><code>###############################################################################\n# Ansible Collection Test Environment Configuration\n###############################################################################\n# Change environment variable names based on collection name to prevent\n# collisions.\n\n# Ansible serving/caching directory for controller node (high read/writes).\nexport SRV_DEPLOY=\"${HOME}/.ansible\"  # ${ANSIBLE_HOME}\n\n# Ansible python virtual environment (high read/writes)\nexport SRV_VENV='/var/venv/{REPO}'\n\n# SRV git repository root directory (high read only)\nexport SRV_GIT='/var/git/{REPO}'\n\n###############################################################################\n# Ansible Serve Config (2.18.1)\n###############################################################################\n# All configuration is done using environment variable per best practice. Check\n# both core and community options when setting or changing values.\n#\n# Generated with:\n#\n#   ansible-config init -t all -f env &gt; /tmp/ansible-env.cfg\n#\n# Environment options are:\n# * Explicitly set\n# * Not internal-only settings\n# * Deprecated settings actively removed or noted with a TODO if in use\n# * Use sh interpretation (0: False, 1: True; etc)\n#\n# Settings can be validated with (errors will be listed):\n#\n#   source ansible.env\n#   source /run/venv/{REPO}/bin/activate\n#   ansible-config --help\n#   ansible-config dump -t all --only-changed\n\n###############################################################################\n# Ansible (Core) Common Options\n###############################################################################\n# Environment variables for core ansible release.\n#\n# Do not use 'ansible' user (as containers do not have this setup); also do not\n# use custom SSH options as these are not used for podman.\n#\n# Reference:\n# * https://docs.ansible.com/ansible/latest/reference_appendices/config.html\n\nexport ANSIBLE_CONFIG=''  # Do not use config files.\nexport ANSIBLE_DISPLAY_SKIPPED_HOSTS=0  # Do not display skipped hosts.\nexport ANSIBLE_DUPLICATE_YAML_DICT_KEY='error'  # Explicit duplicate errors.\nexport ANSIBLE_STDOUT_CALLBACK='debug'  # ansible-doc -t callback -l.\nexport ANSIBLE_USE_PERSISTENT_CONNECTIONS=1  # Persist SSH connections.\n\n###############################################################################\n# Ansible (Collection) Environment Options\n###############################################################################\n# Environment variables for non-core ansible collections.\n#\n# Reference:\n# * https://docs.ansible.com/ansible/latest/collections/environment_variables.html#list-of-collection-env-vars\n\nexport ANSIBLE_ADMIN_USERS='root'  # Only enable root by default.\nexport ANSIBLE_PARAMIKO_RECORD_HOST_KEYS=0  # Ignore host keys.\nexport ANSIBLE_REMOTE_TMP='/tmp'  # Use RAMFS tmp, not (~/.ansible/tmp).\nexport ANSIBLE_SYSTEM_TMPDIRS='/tmp'  # Use RAMFS tmp, not (/var/tmp).\n\n###############################################################################\n# Activate Ansible Virtual Environment\n###############################################################################\nsource \"${SRV_VENV}/bin/activate\"</code></pre>"},{"location":"ansible/collection/#one-time-initialization","title":"One-time initialization","text":"<p>Initialization requires the FQCN, however the repository is typically flat. Create the skeleton template and move to repository base.</p> <pre><code>cd ~/git/{REPO}\nsource ansible.env\nansible-galaxy collection init --init-path . r_pufky.{COLLECTION}\nmv -vn r_pufky/{COLLECTION}/* .\nrm -rfv r_pufky\nmkdir -p plugins/modules  #  Optional for Python modules.</code></pre> <p>Tip</p> <p>Alternatively copy an existing collection and remove unused options. Be sure to update all remaining files.</p> <p>Reference:</p> <ul> <li>https://docs.ansible.com/ansible/latest/dev_guide/developing_collections_structure.html#collections-doc-dir</li> <li>https://github.com/ansible-collections/collection_template/tree/main</li> <li>https://goetzrieger.github.io/ansible-collections/5-creating-collections/</li> </ul>"},{"location":"ansible/collection/#enable-submodule-summaries-and-out-of-date-checks","title":"Enable Submodule Summaries and Out of Date Checks","text":"<p>Check out of date/uncommitted submodules on push to provide a better summary of submodule status (stored in <code>.git/config</code>).</p> <p>Enable submodule summary on main repo commits/status. </p><pre><code>git config status.submodulesummary 1</code></pre><p></p> <p>Check for submodules out of date/uncommitted when pushing main repo. </p><pre><code>git config push.recurseSubmodules check</code></pre><p></p> <p>Reference:</p> <ul> <li>https://docs.ansible.com/ansible/latest/community/collection_contributors/collection_requirements.html</li> <li>https://docs.ansible.com/ansible/latest/reference_appendices/release_and_maintenance.html#ansible-core-support-matrix</li> <li>https://docs.ansible.com/ansible/latest/dev_guide/developing_collections_structure.html#collection-structure</li> <li>https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.html#magic-variables</li> <li>https://ansible.readthedocs.io/projects/lint/rules/</li> <li>https://yamllint.readthedocs.io/en/stable/rules.html</li> </ul>"},{"location":"ansible/collection/commit/","title":"Commit Checks","text":""},{"location":"ansible/collection/commit/#commit-checks","title":"Commit Checks","text":"<p>Prerequisites</p> <ul> <li>Ansible Environment.</li> </ul>"},{"location":"ansible/collection/commit/#ensure-all-todos-are-valid","title":"Ensure all TODOs are valid","text":"<pre><code>grep -ri todo</code></pre>"},{"location":"ansible/collection/commit/#ensure-linting-follows-guidelines","title":"Ensure linting follows guidelines","text":"<pre><code>grep -ri yamllint  # yamllint\ngrep -ri noqa  # ansible-lint</code></pre>"},{"location":"ansible/collection/commit/#lint-returns-clean","title":"Lint returns clean","text":"<pre><code>yamllint .\nansible-lint .</code></pre> Reference: <ul> <li>https://yamllint.readthedocs.io/en/stable/</li> <li>https://ansible.readthedocs.io/projects/lint/rules/</li> </ul>"},{"location":"ansible/collection/commit/#add-collection-ignore-files","title":"Add collection ignore files","text":"<p>Add files that should not be included in the built collection such as tests.</p> <p>galaxy.yml </p><pre><code>build_ignore:\n  - .gitignore\n  - changelogs/.plugin-cache.yaml</code></pre> Reference:<p></p> <ul> <li>https://docs.ansible.com/ansible/devel/dev_guide/developing_collections_distributing.html#ignoring-files-and-folders</li> </ul>"},{"location":"ansible/collection/commit/#update-collection-submodule-reference","title":"Update collection submodule reference","text":"<p>Required otherwise the collection will not use the updated module on checkout.</p> <p>See submodule Updates and Commit</p>"},{"location":"ansible/collection/commit/#versioning","title":"Versioning","text":"<p>Only tag versions when a new release is ready. See Major Release Guide.</p>"},{"location":"ansible/collection/commit/#track-project-updates","title":"Track Project Updates","text":"<ul> <li>Always link to the latest release (or release page).</li> <li>Set alerts to check for new release (or push notifications) for each role.</li> </ul>"},{"location":"ansible/collection/commit/#build-galaxy-release","title":"Build Galaxy Release","text":"<pre><code>ansible-galaxy collection build\nansible-galaxy collection publish  # Alternatively manually upload to Galaxy.</code></pre> Reference: <ul> <li>https://docs.ansible.com/ansible/latest/dev_guide/developing_collections_creating.html</li> </ul>"},{"location":"ansible/collection/release/","title":"Major Release Guide","text":""},{"location":"ansible/collection/release/#major-release-guide","title":"Major Release Guide","text":"<p>Decision: Distro versions are too disparate</p> <p>Major release versions have too many changes to realistically track both, especially after migrating to a new platform. Always leave artifacts so those who wish to stay behind may handle the cost of staying behind themselves.</p> <p>Only maintain active development for current Debian release; users using older releases are welcome to download the specific branch and maintain themselves.</p>"},{"location":"ansible/collection/release/#create-old-major-branch","title":"Create Old Major Branch","text":"<p>Assumes branching 12.x and starting 13.x development.</p> <ol> <li>Commit all open changes (or stash).</li> <li>Update <code>README.md</code>.     <pre><code>### Releases\nMajor release versions track Debian release versions:\n\n* **[13.x.x](https://github.com/r-pufky/ansible_apt)**: 13 Trixie.\n* **[12.x.x](https://github.com/r-pufky/ansible_apt/tree/12.x)**: 12 Bookworm.</code></pre></li> <li>Commit     <pre><code>Final Debian 12.x release.\n\nUpdate README.md for Distro releases.</code></pre></li> <li>Create Old Major Branch and Push     <pre><code>git tag 12.x.x  # Last version for commit above.\ngit push &amp;&amp; git push --tags\ngit checkout -b 12.x  # {ID} if a specific commit is needed.\ngit push -u origin 12.x\ngit checkout main</code></pre></li> <li> <p>Update known settings to new version</p> <ul> <li>Test images<ul> <li><code>debian-systemd:12</code> \u2794 <code>debian-systemd:13</code></li> <li><code>debian/bookworm64</code> \u2794 <code>inception-of-things/debian-trixie</code></li> <li><code>debian-12-</code> \u2794 <code>debian-</code></li> </ul> </li> <li>Entire role   <pre><code>grep bookworm # Replace with trixie.\ngrep 12.x # Replace with 13.x.\ngrep fail:  # Update formatting.\ngrep debug:  # Update formatting.\ngrep msg:  # Update formatting.\ngrep -ri todo  # Resolve any open TODO's.\ngrep -ri noqa  # Minimize NOQA's for accepted ansible-lint disables.</code></pre></li> <li>Update vars/main.yml (dates, packages, etc.).</li> <li>Fix any code warts.</li> <li>Update docstring formats.</li> <li>Implement MAJOR role changes.</li> <li>Check updated packages for new variables.</li> <li>Diff links (esp distro versions) for added/removed items, updated links.   <pre><code>meld \\\n  &lt;(curl -s https://forgejo.org/docs/v11.0/admin/config-cheat-sheet/)\n  &lt;(curl -s https://forgejo.org/docs/v10.0/admin/config-cheat-sheet/)</code></pre></li> <li> <p>Update meta/main.yml.</p> <p>Decision: Use aggressive deprecation</p> <p>Remove previous versions when in-depth workarounds are required. Previous OS support encoded in historical build artifacts.</p> </li> <li> <p>Update galaxy.yml.</p> </li> <li> <p>Update changelogs/changelog.yaml</p> <p>Truncate changelog and use <code>ancestor: {LAST VERSION}</code> to link to previous version changelog.</p> </li> </ul> </li> </ol>"},{"location":"ansible/collection/release/#versioning","title":"Versioning","text":"<p>Default to schematic versioning - each signifier may inherit versioning scheme used for underlying system.</p> Collection: {OS}-{MAJOR}-{MINOR} <p>12.1.1</p> <ul> <li>12 - Debian 12 Bookworm (breaking changes).</li> <li>1 - Collection major version 1 (breaking changes).</li> <li>1 - Collection minor version 1 (non-breaking changes).</li> </ul> <p>On a new debian release:</p> <ul> <li>Create a hard branch for release (with codename).</li> <li>Main becomes the new Debian release.</li> <li>Mark branch release as no longer supported (after migration is completed).</li> </ul> Role: {OS}-{SERVICE}-{ROLE} <p>12-2.0.3-1.0.0</p> <ul> <li>12 - Debian 12 (bookworm).</li> <li>2.0.3 - Service/app version.</li> <li>1.0.0 - Role version.</li> </ul> <p>On a new debian release:</p> <ul> <li>Create a hard branch for release (with codename).</li> <li>Main becomes the new Debian release.</li> <li>Mark branch release as no longer supported (after migration is completed).</li> </ul> <p>Roles may override default format.</p>"},{"location":"ansible/collection/release/#build","title":"Build","text":"<pre><code>ansible-galaxy collection build</code></pre> Sanity check size/contents for unwanted inclusions."},{"location":"ansible/collection/release/#release","title":"Release","text":"<ol> <li> <p>Upload new artifact to https://galaxy.ansible.com</p> <p>Confirm that collection markdown is formatted correctly (Ansible uses a subset of GFM to render documents and may differ from Github). Rebuild and re-upload as needed.</p> </li> <li> <p>Create github release.</p> <ul> <li>Use galaxy.yml for commit template. See previous releases.</li> </ul> </li> </ol>"},{"location":"ansible/collection/release/#release-order","title":"Release Order","text":"<p>Collections depend on lower level dependencies. Release in this order:</p> <ol> <li>data</li> <li>lib</li> <li>deb</li> <li>srv</li> <li>arr</li> <li>game</li> <li>docs</li> </ol>"},{"location":"ansible/collection/testing/","title":"Testing","text":""},{"location":"ansible/collection/testing/#testing","title":"Testing","text":"<p>Prerequisites</p> <ul> <li>Ansible Environment.</li> </ul> <p>Use community references for examples on specific implementations:</p> <ul> <li>Filter Plugins</li> <li>Integration Tests</li> </ul>"},{"location":"ansible/collection/testing/#build-and-install-local-collection","title":"Build and Install Local Collection","text":"<p>The collection must be built and installed locally to be tested.</p> <p>Package built using semantic version from <code>galaxy.yml</code> and installed to local collections cache: <code>~/.ansible/collections/ansible_collections/{USER}/{COLLECTION}</code>.</p> <p></p><pre><code>ansible-galaxy collection build -f  # -f (force) useful for repeated testing.\nansible-galaxy collection install -f  # -f (force) useful for repeated testing.</code></pre> Collection will need to be rebuilt if changes (files or tests) were made.<p></p>"},{"location":"ansible/collection/testing/#running-tests","title":"Running Tests","text":"<p>Any change requires rebuilding, installing AND re-entering directory as inodes change.</p> <p>Alway build and install before running tests.</p> <p></p><pre><code># Always re-enter between installs - cd ~; cd -\ncd ~/.ansible/collections/ansible_collections/{USER}/{COLLECTION}\nansible-test {unit,integration,sanity}</code></pre> Reference:<p></p> <ul> <li>https://docs.ansible.com/ansible/latest/dev_guide/developing_collections_testing.html</li> <li>https://docs.ansible.com/ansible/latest/dev_guide/testing_running_locally.html#testing-running-locally</li> <li>https://docs.ansible.com/ansible/latest/dev_guide/developing_collections_testing.html#testing-collections</li> <li>https://medium.com/@andrewjamesdawes/run-ansible-test-integration-tests-locally-on-docker-and-over-ssh-d8d658ba118b</li> </ul>"},{"location":"ansible/collection/troubleshooting/","title":"Troubleshooting","text":""},{"location":"ansible/collection/troubleshooting/#troubleshooting","title":"Troubleshooting","text":""},{"location":"ansible/collection/troubleshooting/#testing-in-roles-uses-old-files","title":"Testing in roles uses old files","text":"<p>Collection cache is outdated.</p> <p>Clear build cache. </p><pre><code>rm -rfv ~/.ansible/collections/ansible_collections/r_pufky/srv</code></pre><p></p>"},{"location":"ansible/collection/troubleshooting/#unable-to-determine-context-for-the-following-test-targets","title":"Unable to determine context for the following test targets","text":"<p>A controller and a target were not specified when running the test.</p> Error <pre><code>WARNING: Unable to determine context for the following test targets, they will\nbe run on the target host: {MODULE}, {MODULE}, they will be run on the target\nhost: {MODULE}, {MODULE}</code></pre> <p>This is OK for tests that are run on localhost with NO impact on system (e.g. filters).</p>"},{"location":"ansible/collection/troubleshooting/#only-localhost-is-available","title":"Only Localhost is Available","text":"<p>Host inventory not detected when running collection tests.</p> Error <pre><code>ansible-playbook roles/hello_motd/tests/playbook/test_hello_motd.yml\n...\n  [WARNING]: No inventory was parsed, only implicit localhost is available\n  [WARNING]: provided hosts list is empty, only localhost is available. Note\n  that the implicit localhost does not match 'all'</code></pre> <p>Explicitly specify inventory to use. </p><pre><code>ansible-playbook -i tests/inventory tests/playbook/test_hello_motd.yml</code></pre><p></p> <p>Tip</p> <p>--ask-become-pass will be needed if sudo used or use GPG key injection.</p>"},{"location":"ansible/collection/troubleshooting/#fixing-gplv3-license-missing","title":"Fixing GPLv3 License Missing","text":"<p>Community distributions assumes GPLv3.</p> <p>Explicitly ignore if different license. </p><pre><code>mkdir -p tests/sanity\ntouch tests/sanity/ignore-{ANSIBLE VERSION}.txt\n\ntouch tests/sanity/ignore-2.16.txt</code></pre><p></p> <p>Warning</p> <p>An ignore file is required for each specific version of ansible.</p> <p>Tip</p> <p>Order Matters: if ignores are throwing warnings, check ordering and make sure they are ordered correctly. Proper ignores will not generate warnings.</p> <p>Info</p> <p>Only certain ignores are explicitly allowed; others will always throw ansible-lint errors even if ignored.</p> <p>tests/sanity/ignore-2.16.txt </p><pre><code>plugins/modules/demo_hello.py compile-2.7!skip\nplugins/modules/demo_hello.py import-2.7!skip\nplugins/modules/demo_hello.py compile-3.6!skip\nplugins/modules/demo_hello.py import-3.6!skip\nplugins/modules/demo_hello.py compile-3.7!skip\nplugins/modules/demo_hello.py import-3.7!skip\nplugins/modules/demo_hello.py compile-3.8!skip\nplugins/modules/demo_hello.py import-3.8!skip\nplugins/modules/demo_hello.py compile-3.9!skip\nplugins/modules/demo_hello.py import-3.9!skip\nplugins/modules/demo_hello.py compile-3.10!skip\nplugins/modules/demo_hello.py import-3.10!skip\nplugins/modules/demo_hello.py compile-3.12!skip\nplugins/modules/demo_hello.py import-3.12!skip\nplugins/modules/demo_hello.py validate-modules:missing-gplv3-license</code></pre> Reference:<p></p> <ul> <li>https://github.com/ansible/ansible/issues/67032</li> <li>https://docs.ansible.com/ansible/latest/dev_guide/testing/sanity/ignores.html</li> <li>https://docs.ansible.com/ansible/latest/dev_guide/testing/sanity/validate-modules.html</li> <li>https://ansible.readthedocs.io/projects/lint/rules/sanity/</li> </ul>"},{"location":"ansible/environment/","title":"Ansible Environment","text":""},{"location":"ansible/environment/#ansible-environment","title":"Ansible Environment","text":"<p>Decision: Use isolated minimal environments</p> <p>Each collection uses an isolated minimal environment to minimize hidden dependencies.</p>"},{"location":"ansible/environment/#create-environment-and-install-packages","title":"Create Environment and Install Packages","text":"<p>Create python virtual environment, install Ansible and Molecule </p><pre><code>python3 -m venv /var/venv/{REPO}  # Bare name (ansible_collection_srv).\nsource /var/venv/{REPO}/bin/activate\npip install --upgrade pip\npip install --upgrade setuptools\n# Lock to specific version. See reference.\npip install ansible  # ansible==11.0  # ansible-core 2.18\npip install argcomplete\n# Install older ansible-compat layer until issue is resolved.\n# Reference:\n# * https://github.com/ansible/ansible-lint/issues/4533\n# pip install ansible-lint\n# pip install molecule\npip uninstall -y ansible-compat ansible-lint molecule\npip install \"ansible-compat==24.10.0\" ansible-lint molecule</code></pre> Reference:<p></p> <ul> <li>https://docs.ansible.com/ansible/latest/roadmap/ansible_roadmap_index.html</li> <li>https://docs.ansible.com/ansible/2.9/installation_guide/intro_installation.html</li> </ul>"},{"location":"ansible/environment/#set-alternative-ansible-cache-location","title":"Set alternative .ansible cache location","text":"<p>A recent change in Ansible now creates an .ansible directory in each directory ansible is run - building and copying all collections/roles recursively - potentially creating multi-GB PER directory. Leads to extremely slow and noisy yamllint and ansible-lint usage.</p> <p>/etc/fstab </p><pre><code>tmpfs  /tmp/ansible-cache  tmpfs  noatime,mode=1777  0 0</code></pre><p></p> <p>Mount new directory </p><pre><code>mount -o remount -a</code></pre><p></p> <p>Symlink all directories to cache </p><pre><code>find . -type d -name '.ansible' -exec rm -rf \"{}\" \\; -exec ln -s /tmp/ansible-cache \"{}\" \\;</code></pre> Reference:<p></p> <ul> <li>https://github.com/ansible/ansible-lint/issues/4533</li> </ul>"},{"location":"ansible/environment/#set-alternative-container-storage-location-optional","title":"Set alternative container storage location (optional)","text":"<p>Developing ansible will thrash disk especially when running playbooks and testing with molecule. Relocate high-use directories to a disk that can handle high wear. Prefer to config change as this enables vanilla use in production.</p> <p>Link ansible caching directories. (1)</p> <ol> <li>Consider moving and linking entire .cache directory.</li> </ol> <pre><code># Delete or move existing cache data.\nln -s /mnt/cache/.ansible_async ${HOME}/.ansible_async\nln -s /mnt/cache/.ansible ${HOME}/.ansible\nln -s /mnt/cache/cache/ansible-compat ${HOME}/.cache/ansible-compat\nln -s /mnt/cache/cache/molecule ${HOME}/.cache/molecule</code></pre>"},{"location":"ansible/environment/vscodium/","title":"VSCodium (VScode)","text":""},{"location":"ansible/environment/vscodium/#vscodium-vscode","title":"VSCodium (VScode)","text":"<p>Install Ansible extension</p>"},{"location":"ansible/environment/vscodium/#configure-workspace","title":"Configure Workspace","text":"<p>ansible \u2794 settings \u2794 user \u2794 workspace</p> Option Setting Ansible: Path /var/venv/{REPO}/bin/ansible Ansible: Use Fully Qualified Collection Names \u2714 Ansible: Reuse Terminal \u2714 Python: Interpreter Path /var/venv/{REPO}/bin/python Python: Activation Script /var/git/{REPO}/ansible.env Ansible: Navigator Path ansible-navigator Completion: Provide Redirect Modules \u2714 Completion: Provide Module Option Aliases \u2714 Validation: Enabled \u2714 Lint: Enabled \u2714 Lint: Path ansible-lint Execution Environment: Container Engine auto Execution Environment: Image ghcr.io/ansible/community-ansible-dev-tools:latest Pull: Policy missing Telemetry: Enabled \u2718 Lightspeed: Enabled \u2718 <p>Disable <code>ansible-lint</code> for documentation to prevent incorrect YAML error reporting.</p> <p>Extensions \u2794 Ansible \u2794 Settings \u2794 Folder </p><pre><code>ansible.validation.lint.enabled: false</code></pre><p></p>"},{"location":"ansible/environment/vscodium/#set-alternative-container-storage-location-optional","title":"Set alternative container storage location (optional)","text":"<p>Developing ansible will thrash disk especially running ansible-lint after every file save. Relocate high-use directories to a disk that can handle high wear. Prefer to config change as this enables vanilla use.</p> <pre><code># delete or move existing cache data.\nln -s /mnt/cache/config/VSCodium ${HOME}/.config/VSCodium</code></pre>"},{"location":"ansible/role/","title":"Role Developemnt","text":""},{"location":"ansible/role/#role-developemnt","title":"Role Developemnt","text":"<p>Prerequisites</p> <ul> <li>Ansible Environment.</li> <li>Collection Created.</li> </ul>"},{"location":"ansible/role/#create-new-role","title":"Create New Role","text":""},{"location":"ansible/role/#add-role-as-submodule","title":"Add role as submodule","text":"<p>Always add roles from repository root as submodules.</p> <p></p><pre><code>git submodule add https://github.com/{USER}/{REPO} roles/{ROLE}</code></pre> Reference:<p></p> <ul> <li>https://git-scm.com/book/en/v2/Git-Tools-Submodules</li> </ul>"},{"location":"ansible/role/#create-role-template-files-optional","title":"Create role template files (optional)","text":"<p>Ansible galaxy will overwrite GIT metadata when run directly on the submodule. Instead write a skeleton role and copy data in as-needed. See existing roles.</p> <p></p><pre><code>ansible-galaxy role init --init-path /tmp example</code></pre> Reference:<p></p> <ul> <li>https://goetzrieger.github.io/ansible-collections/5-creating-collections/#adding-content-adding-a-custom-role</li> </ul>"},{"location":"ansible/role/#gitignore","title":".gitignore","text":"<pre><code>.ansible/\n.ansible\nmolecule/cache</code></pre> Reference: <ul> <li>https://github.com/r-pufky/ansible_paperless_ngx</li> </ul>"},{"location":"ansible/role/#update-and-commit","title":"Update and Commit","text":"<p>Role must be committed to the repository before a new commit hash can be stored for the collection.</p> <p></p><pre><code>cd roles/{ROLE}\ngit add .\ngit commit\ngit push\ngit submodule update --init  # Update submodule commit hash reference.\ncd {COLLECTION}\ngit add roles/{ROLE}  # Add updated submodule from collection root.</code></pre> Reference:<p></p> <ul> <li>https://git-scm.com/book/en/v2/Git-Tools-Submodules</li> </ul>"},{"location":"ansible/role/best_practices/","title":"Best Practices","text":""},{"location":"ansible/role/best_practices/#best-practices","title":"Best Practices","text":"<ul> <li>Use Data annotations   for all variables touched by role consumer See example.</li> <li>Prefix role variables with <code>{ROLE}_role_</code>.</li> <li>Prefix service variables (required to setup service, not configure it) with   <code>{ROLE}_srv_</code>.</li> <li>Prefix config variables (required for configuring service) with   <code>{ROLE}_cfg_</code>.</li> <li>Always create roles explicitly designed for bare-metal installations.</li> <li>Flag protect container specific options requiring explicit enablement:<ul> <li>Use a collection level flag <code>{COLLECTION}_container_enable</code>.</li> <li>Use a role level flag <code>{ROLE}_container_enable</code>.</li> <li>As the first step in <code>main.yml</code> override role level option if collection   value is set (See example).</li> </ul> </li> <li> <p>Handle local and remote mounted data storage possibilities:</p> <ul> <li>Provide option for executing task as 'root' or specified user.</li> <li>Use UID/GID for those locations for remote filesystem accommodation.</li> <li>See existing roles.</li> </ul> </li> <li> <p>Use the style guide.</p> </li> <li>Always include last update date, version, and OS release in <code>vars/main.yml</code>:   <pre><code># Last time {ROLE} options were validated against a default configuration.\n{ROLE}_role_validate_date: '2024-06-14'\n{ROLE}_role_validate_release: 'bookworm'\n\n# Default packages for {ROLE}.\n{ROLE}_role_packages:\n  - 'ssh'  # meta package provides both ssh and sshd.\n\n# Default random data.\n{ROLE}_role_generated_api_key: '{{\n    lookup(\"ansible.builtin.password\",\n           \"/dev/null\",\n           chars=[\"ascii_letters\", \"digits\"],\n           length=32)\n  }}'</code></pre></li> </ul> <p>Reference:</p> <ul> <li>https://docs.ansible.com/ansible/2.8/user_guide/playbooks_best_practices.html</li> <li>https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.html#magic-variables</li> <li>https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_filters.html#providing-default-values</li> <li>https://ansible.readthedocs.io/projects/lint/rules/</li> <li>https://yamllint.readthedocs.io/en/stable/rules.html</li> <li>https://docs.ansible.com/ansible/latest/dev_guide/migrating_roles.html</li> </ul>"},{"location":"ansible/role/style_guide/","title":"Style Guide","text":""},{"location":"ansible/role/style_guide/#style-guide","title":"Style Guide","text":"<p>Tip</p> <p>Prefer readability and consistency across files minimizing exceptions.</p> <p>Warning</p> <p>Always follow yamllint and ansible-lint linting with no global exceptions. See examples.</p>"},{"location":"ansible/role/style_guide/#80-character-width","title":"80 character width","text":"<p>Only extend past 80 characters if long variable names make it impossible.</p> <pre><code>- ansible.builtin.set_fact:\n    JWT_SIGNING_PRIVATE_KEY_FILE:\n      '{{ forgejo_config_server_app_data_path }}/jwt/private.pem',\n    JWT_SIGNING_ALGORITHM: '{{\n        forgejo_config_oauth2_jwt_signing_algorithm | upper\n      }}',\n    SSH_TRUSTED_USER_CA_KEYS_FILENAME: '{{\n        _forgejo_home ~ \"/.ssh/ca_trust_chain_root.pem\"\n        if forgejo_config_server_ssh_trusted_user_ca_keys_filename | length &gt; 0 else\n        \"\"\n      }}',\n\n- ansible.builtin.set_fact:\n    _unifi_cfg_legacy_properties_unifi_https_ssl_enabled_protocols: \"{{\n      {} | r_pufky.data.v3(\n        section='system.properties',\n        key='unifi.https.sslEnabledProtocols',\n        raw=unifi_cfg_legacy_properties_unifi_https_ssl_enabled_protocols,\n        data=(\n          unifi_cfg_legacy_properties_unifi_https_ssl_enabled_protocols |\n          join(',')\n        ),\n        default=['TLSv1', 'SSLv2Hello'],\n        hint='list of str',\n        keep=false,\n        order=17\n        )\n      }}\"</code></pre> <ul> <li>Single-line uses 2 space block (prefer).</li> <li>Multi-line vars use hanging opens with 4 space block and 2 closer;   lines may go over 80 characters if it cannot be split further using these   rules.</li> <li>If statements use hanging opens with 4 space block and 2 closer; one   line per operator and may each individually go over 80 character limit.</li> </ul>"},{"location":"ansible/role/style_guide/#accepted-disables","title":"Accepted Disables","text":""},{"location":"ansible/role/style_guide/#line-length","title":"line-length","text":"<pre><code>---\n# yamllint disable rule:line-length\n...\n# yamllint enable rule:line-length\nsome_long_yaml_line: 0  # yamllint disable-line rule:line-length</code></pre> <ul> <li>Must appear immediately after YAML specifier if file disabled.</li> <li>Enable as soon as possible if file level disable.</li> </ul>"},{"location":"ansible/role/style_guide/#jinjaspacing","title":"jinja[spacing]","text":"<p>Disable for complex tasks (such as filters or combining dicts) - prefer human readability.</p> <pre><code>- name: 'Annotate | sanitize &amp; annotate service defaults'\n  ansible.builtin.set_fact:  # noqa jinja[spacing] readability.\n    _unifi_srv_legacy_enable: \"{{ {} | r_pufky.data.v3(\n        raw=unifi_srv_legacy_enable,\n        default=true,\n        _dir='/var/lib/unifi',\n        _properties='/var/lib/unifi/system.properties',\n        hint='bool',\n        order=1\n        )\n      }}\"</code></pre>"},{"location":"ansible/role/style_guide/#nametemplate","title":"name[template]","text":"<p>For multiple variables in a name directive - typically file paths.</p> <pre><code>- name: 'file: {{ item.path }}/.hidden_file'  # noqa name[template] file path</code></pre>"},{"location":"ansible/role/style_guide/#no-handler","title":"no-handler","text":"<p>Immediately execute command or handler in cases where results are required for role to progress.</p> <pre><code>- name: Update checksum'\n  when: _test_prepare.changed  # noqa no-handler execute immediately.\n  ansible.builtin.command:\n    argv:\n      - 'sed'\n      - '-i'\n      - 's/11.0.3/11.0.4/g'\n      - '{{ _test_cache }}/forgejo-11.0.4-linux-amd64.sha256'\n  changed_when: true</code></pre>"},{"location":"ansible/role/style_guide/#name-directives","title":"Name Directives","text":""},{"location":"ansible/role/style_guide/#tasks","title":"Tasks","text":"<p>Use bare descriptions with pipes for multi-part steps.</p> <pre><code>- name: 'Config'\n  ansible.builtin.include_tasks: 'config.yml'  # tasks/main.yml\n\n- name: 'File | disable firewall'  # tasks/file.yml\n  when: not ufw_enable\n  community.general.ufw:\n    state: 'disabled'\n\n- name: 'Sub section | file | disable firewall'  # tasks/sub_section/file.yml.\n  when: not ufw_enable\n  community.general.ufw:\n    state: 'disabled'</code></pre>"},{"location":"ansible/role/style_guide/#clause-order","title":"Clause Order","text":"<p>Prioritized for readability and clarity.</p> <pre><code>- name: 'task with a clause'\n  when: some_var_to_test  # place 'when' next to loop if clause uses loop item.\n  notify: 'handler'\n  community.general.ufw:\n    state: 'disabled'\n  become: true\n  register: _some_var\n  loop: '{{ user_accounts }}'\n  loop_control:\n    label: '{{ item.user }}'</code></pre>"},{"location":"ansible/role/style_guide/#handler-listen-clauses","title":"Handler (listen clauses)","text":"<p>Use listen clause to run multiple handlers for a given task. listen can be a list, allowing for specific combinations as needed.</p> <p>Execution order is always the order as written in <code>handlers.yml</code>, regardless of call order.</p> <p>Handlers. </p><pre><code>- name: 'Handlers | ifreload'\n  listen:\n    - 'Handlers | reload restart networking'\n    - 'Handlers | reload restart FRR'\n  ansible.builtin.command: '/usr/sbin/ifreload -a'\n  become: true\n  changed_when: false\n\n- name: 'Handlers | restart networking'\n  listen: 'Handlers | reload restart networking'\n  when: network_systemctl_network_restart\n  ansible.builtin.service:\n    name: 'networking'\n    state: 'restarted'\n  changed_when: true\n\n- name: 'Handlers | restart FRR'\n  listen: 'Handlers | reload restart frr'\n  ansible.builtin.service:\n    name: 'frr'\n    state: 'restarted'</code></pre><p></p> <p>Usage. </p><pre><code>- name: 'run restart networking'\n  notify: 'Handlers | reload restart networking'\n  ...\n\n- name: 'run ifreload, restart networking'\n  notify: 'Handlers | reload restart networking'\n  ...\n\n- name: 'run ifreload, restart FRR'\n  notify: 'Handlers | reload restart FRR'\n  ...</code></pre><p></p> <p>Reference:</p> <ul> <li>https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_handlers.html</li> <li>https://github.com/ansible/ansible/issues/16378</li> </ul>"},{"location":"ansible/role/style_guide/#file-section-headers","title":"File / Section Headers","text":"<p>One vertical space to allow for individual task and variable comments.</p> <pre><code>###############################################################################\n# Capped Header Text (Clarifications)\n###############################################################################\n# Reference:\n# * https://some/reference\n\n- name: 'task with a clause'\n  when: some_var_to_test\n  community.general.ufw:\n    state: 'disabled'</code></pre>"},{"location":"docstring/","title":"Style Guide","text":""},{"location":"docstring/#style-guide","title":"Style Guide","text":"<p>Tip</p> <p>Always prefer consistency in documentation and update if file is touched.</p>"},{"location":"docstring/#format-rules","title":"Format Rules","text":"Style Rule 80 Character width. 2 Spaces per tab. 2 Spaces - nested section. 4 Spaces - extended text from previous line. 1 Vertical space between sections. . All lines end in <code>.</code> for complete statement unless exactly 80. # Comment - all lines end in <code>.</code> unless exactly 80. Tense Always use present active tense for concise documentation."},{"location":"docstring/#naming-conventions","title":"Naming Conventions","text":"Style Rule <code>var_name</code> Variables are unquoted in paragraphs. <code>{ROLE}_srv_{VAR}</code> Role default variable for external service setup. <code>{ROLE}_cfg_{VAR}</code> Role default variable for internal service configuration. <code>{ROLE}_role_{VAR}</code> Internal role variable use. <code>_{ROLE}_{VAR}</code> Runtime internal role variable use. <code>^$*{VAL}</code> regex expressions are allowed; use <code>N/A</code> not applicable <code>':'</code> Always quote to disambiguate separators."},{"location":"docstring/#abbreviated-data-types","title":"Abbreviated Data Types","text":"Type Default <code>int</code> <code>#</code> (not empty). <code>float</code> <code>#.#</code> (not empty). <code>bool</code> <code>True</code> or <code>False</code> (not empty). <code>str</code> <code>''</code> <code>list</code> <code>[]</code> <code>dict</code> <code>{}</code> <code>{TYPE} of {TYPE}</code> Outer most type first (e.g. list of str - <code>[]</code>). <code>{TYPE} or {TYPE}</code> Multiple types - preferred type first."},{"location":"docstring/#todo","title":"TODO","text":"<p>Place anywhere where additional work is needed. No restrictions.</p> <pre><code># TODO(bug): List deletion via API is currently broken. This is fixed in the\n#     next PiHole release. Lists will still be managed, but cannot be deleted.\n# \u22ee Good TODO categories: bug, role, user, {VERSION}.</code></pre>"},{"location":"docstring/#alternative-context","title":"\u22ee Alternative Context","text":"<p>Include alternative docstring format or context inline with the docstring option. This provides self-documenting expanded use features.</p> <pre><code># Requires role_other_option=true.\n# \u22eeRequires:\n# \u22ee* multi_option_one='value'.\n# \u22ee* multi_option_two=true.</code></pre>"},{"location":"docstring/task/","title":"Tasks","text":""},{"location":"docstring/task/#tasks","title":"Tasks","text":"<p>Provide development notes, overall process, required state before executing, post-execution state, and related information for understanding what tasks are trying to accomplish.</p> <p>A developer should be ableto read this section and get an understanding of what you are trying to do without explicitly walking through each step (that's what tasks do!).</p> <pre><code>###############################################################################\n# Capped Header (Context)\n###############################################################################\n# Immediate start description of task set.\n#\n# WARNING\n# &gt; Detailed end-user explanation of warning. **ALL** warnings are copied\n# &gt; verbatim to README.md.\n#\n# NOTE\n# &gt; Detailed explanation for developer of critical cases which hard to debug\n# &gt; failures will occur. Provide explanation, workarounds, and fixes.\n#\n# Requires role_other_option=true.\n# \u22eeRequires:\n# \u22ee* multi_option_one='value'.\n# \u22ee* multi_option_two=true.\n#\n# Versions (Schematic):\n#       MAJOR: Unsafe - requires major role changes; only default MAJOR version\n#              is supported. See other branches if they exist.\n#       MINOR: Unsafe - Paperless has a history of introducing breaking changes\n#              on minor updates (see 2.14, 2.15, 2.16). These should be\n#              considered 'major' versions. See other branches if they exist.\n#       PATCH: Safe - Usually requires no role updates. Some have included\n#              breaking changes (2.16.0 - 2.16.2).\n#   RECOMMEND: Only increment PATCH. Never use 'latest'.\n# \u22eeAlways recommend and provide context for safe option changes.\n#\n# Security: CVE-2023-48795\n#   CVE:\n#   * https://nvd.nist.gov/vuln/detail/cve-2023-48795\n#   * https://nvd.nist.gov/vuln/detail/cve-2023-46445\n#   * https://nvd.nist.gov/vuln/detail/cve-2023-46446\n#   * https://nvd.nist.gov/vuln/detail/cve-2024-41909\n#   Decision: remove chacha20 cipher, *-etm MAC - disables attack for modern\n#       systems, remove when OpenSSH 9.6 released with strict key exchange.\n#   Mitigation:\n#   * remove 'chacha20-poly1305@openssh.com' from client ciphers.\n#   * remove '*-etm@openssh.com' from server macs.\n#   Reference:\n#   * https://terrapin-attack.com/#scanner\n#   * https://www.openssh.com/txt/release-9.6\n# \u22eeMost critical security vulnerability first.\n#\n# Decision: Only manage owner - REST API does not provide a good way to set\n#     user passwords (requires old and new passwords), etc; without directly\n#     editing DB. Instead create required user so user can login.\n# \u22eeExplain opinionated or complex decision for implementing a specific way.\n# \u22eeBe clear and concise as to decision and supporting reasoning.\n#\n# Paragraph documentation.\n# \u22eeMake it unambiguously clear what variable does. Present, active tense,\n# \u22eeremoving superfluous words.\n# \u22ee\n# \u22eeIf it took more than a few seconds to understand write it down now.\n#\n# Special Case:\n#         value: Description (Vertically align values, min indent 2 spaces).\n#   other_value: Other.\n# \u22eeSpecial Case:\n# \u22ee* Non value based cases.\n# \u22ee* All paths are prepended with some_var.\n# \u22ee* Wildcards allowed.\n#\n# Values:\n#            none: explicitly disable use of an authentication agent.\n#              '': no default system agent (default).\n#             ':': clarify colon usage or cases where colon could be confused.\n#   SSH_AUTH_SOCK: get socket location from SSH_AUTH_SOCK environment variable.\n#              $*: strings beginning with $ will be treated as environment\n#                  variable containing the location of the socket.\n#                      Values:\n#                        {VALUE}: additional values for value element.\n# \u22eeAll docstrings can be nested as needed for additional context.\n# \u22eeAlways mark the default option with '(default)'.\n#\n# Args:\n#   db: Postgres DB to manage.\n# \u22eeExplicitly for block/loop idioms to define what variables are required for\n# \u22eetask execution.\n#\n# Generates:\n#   _paperless_ngx: dict - Role runtime specific config.\n#   _paperless_ngx_map: list of dict - Annotated config map.\n#   _paperless_ngx_order: list of str - Config section order.\n# \u22eeRuntime variables that may be consumed in other role task files.\n#\n# Exports:\n#   _sqlite_sql_results: dict - User consumable return values from execution.\n# \u22eeExported variables end-users may consume. Must update README.md.\n# \u22ee\n# \u22eeREADME.md:\n# \u22ee ### Generated Variables\n# \u22ee After successful execution the following variables are available for\n# \u22ee further manipulation during the same play (standard role variable scope):\n# \u22ee\n# \u22ee  Variable            | type | Description\n# \u22ee ---------------------|------|-----------------------------------------\n# \u22ee  _sqlite_sql_results | dict | registered return results from command.\n#\n# Reference:\n# * https://manpages.debian.org/bookworm/openssh-client/ssh_config.5.en.html</code></pre>"},{"location":"docstring/unicode/","title":"Unicode Glyphs","text":""},{"location":"docstring/unicode/#unicode-glyphs","title":"Unicode Glyphs","text":""},{"location":"docstring/unicode/#text-glyphs","title":"Text Glyphs","text":"Glyph Code use \u2794 2794 Menus, sub-items, links. \u26a0 26a0 Warning. \u24d8 24be Informational. \ud83d\uddd8 1f5d8 Waiting. \u2714 2714 Success / Enabled. \u2718 2718 Failure / Disabled. \u2611 2611 Checked / Enabled. \u2610 2610 Unchecked / Disabled. \u22ee 22ee Additional context (or context menu). \u2699 2699 Settings. \u2318 2318 Super key."},{"location":"docstring/unicode/#alert-window-glyphs","title":"Alert Window Glyphs","text":"Glyph Code use \u2500 26a0 horizontal line. \u2502 2502 Vertical line. \u256d 2714 Top left corner. \u256e 2718 Top right corner. \u256f 2718 Bottom right corner. \u2570 2718 Bottom left corner. \u251c 2718 Bottom left message."},{"location":"docstring/unicode/#window-alert","title":"Window Alert","text":"<p>Windows are 70 characters wide with minimum 1 character space horizontally, 1 one vertically. Place raw (unconfined) variable dumps below with additional vertical space:</p> <pre><code>\u256d\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256e\n\u2502                                                                   \u2502\n\u2502   Distribution is being upgraded. This will take a few minutes.   \u2502\n\u2502                                                                   \u2502\n\u2570\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256f\n\n{{ var_dump }}</code></pre>"},{"location":"docstring/unicode/#window-extended","title":"Window Extended","text":"<p>Window Alert with extended information presented immediately below. Variable information is known to be one line (not horizontally constrained):</p> <pre><code>\u256d\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256e\n\u2502                                                                   \u2502\n\u2502   Distribution is being upgraded. This will take a few minutes.   \u2502\n\u2502                                                                   \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256f\n\u2502 extended information\n\u2502\n\u2502 var: {{ var_dump }}</code></pre>"},{"location":"docstring/variable/","title":"Variables","text":""},{"location":"docstring/variable/#variables","title":"Variables","text":"<p>Explicitly document variable use for end users. Only remove sections which are not relevant to variable use even if trivial. A user will not understand something you implicitly do.</p> <pre><code># One line active description of variable.\n# \u22eeSingle line: Description (unit). Default: {VALUE}.\n# \u22eeBoolean values must declare what bool does (enable/disable).\n#\n# WARNING\n# &gt; Detailed end-user explanation of warning. **ALL** warnings are copied\n# &gt; verbatim to README.md.\n#\n# NOTE\n# &gt; Detailed explanation for developer of critical cases which hard to debug\n# &gt; failures will occur. Provide explanation, workarounds, and fixes.\n#\n# Requires role_other_option=true.\n# \u22eeRequires:\n# \u22ee* multi_option_one='value'.\n# \u22ee* multi_option_two=true.\n#\n# Versions (Schematic):\n#       MAJOR: Unsafe - requires major role changes; only default MAJOR version\n#              is supported. See other branches if they exist.\n#       MINOR: Unsafe - Paperless has a history of introducing breaking changes\n#              on minor updates (see 2.14, 2.15, 2.16). These should be\n#              considered 'major' versions. See other branches if they exist.\n#       PATCH: Safe - Usually requires no role updates. Some have included\n#              breaking changes (2.16.0 - 2.16.2).\n#   RECOMMEND: Only increment PATCH. Never use 'latest'.\n# \u22eeAlways recommend and provide context for safe option changes.\n#\n# Security: CVE-2023-48795\n#   CVE:\n#   * https://nvd.nist.gov/vuln/detail/cve-2023-48795\n#   * https://nvd.nist.gov/vuln/detail/cve-2023-46445\n#   * https://nvd.nist.gov/vuln/detail/cve-2023-46446\n#   * https://nvd.nist.gov/vuln/detail/cve-2024-41909\n#   Decision: remove chacha20 cipher, *-etm MAC - disables attack for modern\n#       systems, remove when OpenSSH 9.6 released with strict key exchange.\n#   Mitigation:\n#   * remove 'chacha20-poly1305@openssh.com' from client ciphers.\n#   * remove '*-etm@openssh.com' from server macs.\n#   Reference:\n#   * https://terrapin-attack.com/#scanner\n#   * https://www.openssh.com/txt/release-9.6\n# \u22eeMost critical security vulnerability first.\n#\n# Decision: Only manage owner - REST API does not provide a good way to set\n#     user passwords (requires old and new passwords), etc; without directly\n#     editing DB. Instead create required user so user can login.\n# \u22eeExplain opinionated or complex decision for implementing a specific way.\n# \u22eeBe clear and concise as to decision and supporting reasoning.\n#\n# Paragraph documentation.\n# \u22eeMake it unambiguously clear what variable does. Present, active tense,\n# \u22eeremoving superfluous words.\n# \u22ee\n# \u22eeIf it took more than a few seconds to understand write it down now.\n#\n# Special Case:\n#         value: Description (Vertically align values, min indent 2 spaces).\n#   other_value: Other.\n# \u22eeSpecial Case:\n# \u22ee* Non value based cases.\n# \u22ee* All paths are prepended with some_var.\n# \u22ee* Wildcards allowed.\n#\n# Values:\n#            none: explicitly disable use of an authentication agent.\n#              '': no default system agent (default).\n#             ':': clarify colon usage or cases where colon could be confused.\n#   SSH_AUTH_SOCK: get socket location from SSH_AUTH_SOCK environment variable.\n#              $*: strings beginning with $ will be treated as environment\n#                  variable containing the location of the socket.\n#                      Values:\n#                        {VALUE}: additional values for value element.\n# \u22eeAll docstrings can be nested as needed for additional context.\n# \u22eeAlways mark the default option with '(default)'.\n#\n# role_multi_complex:\n#     list of dict - definitions for local configuration.\n#   - config: str - name of local config ({INCLUDE}/{CONFIG}).\n#     state: str - whether config should be managed or removed.\n#           Additional description details here.\n#\n#           Reference:\n#           * https://example.com\n#         Values:\n#           present: manage configuration\n#            absent: remove configuration\n#         Default: 'present'.\n#     options: dict - ssh_config options to manage (per ssh_config options).\n#       file: str - file location.\n#       mode: str - octal file permissions.\n#           Default: '0644'.\n# \u22eeFor complex variables using condensed docstring format. Nest as needed.\n# \u22eeAlways provide examples showing actual test data (see below).\n#\n# role_multi_complex:\n#   - config: 'custom_ssh_config'\n#     state: 'present'\n#     options:\n#       file: '/etc/example'\n#       mode: '0644'\n#\n# role_multi_complex:\n#   - config: 'alternative_config'\n#     state: 'absent'\n#   - config: 'custom_ssh_config'\n#     state: 'present'\n#     options:\n#       file: '/etc/example'\n#       mode: '0644'\n#\n# Variable: variable_name | type\n# \u22eeDefines an inline extended variable for a variable defined in another file.\n# \u22ee**Only** used for extremely large and complex configurations that have\n# \u22eemultiple overlapping, duplicated options, resulting in 5k+ line default\n# \u22eevalues files.\n# \u22ee\n# \u22eeExtended options are defined in a separate file (with no\n# \u22eeactual YAML variables) and cross-reference actual configuration location.\n# \u22eeSee r_pufky.deb.systemd defaults for example.\n#\n# Default: [] (un-managed).\n# \u22ee Default: (description).\n# \u22ee   - 'long'\n# \u22ee   - 'defaults'\n#\n# Reference:\n# * https://manpages.debian.org/bookworm/openssh-client/ssh_config.5.en.html</code></pre>"},{"location":"test_environments/molecule/","title":"Molecule Setup","text":""},{"location":"test_environments/molecule/#molecule-setup","title":"Molecule Setup","text":"<p>Prerequisites</p> <ul> <li>Ansible Environment.</li> <li>Podman - Primary test framework.</li> <li>Vagrant - Secondary test framework.</li> </ul>"},{"location":"test_environments/molecule/#create-test","title":"Create Test","text":"<p>Directory may also be copied from other existing roles and updated.</p> <pre><code>cd roles/{ROLE}  # molecule always uses current working directory.\n\n# 'default' test using Podman driver.\nmolecule init scenario --driver-name=podman\n\n# 'ssl' test using Vagrant driver.\nmolecule init scenario ssl --driver-name=vagrant</code></pre>"},{"location":"test_environments/molecule/#directory-layout","title":"Directory layout","text":"<p>These may be <code>yml</code> files or directories with <code>yml</code> files inside.</p> <p></p><pre><code>{ROLE}\n\u251c\u2500\u2500 dependency\n\u251c\u2500\u2500 lint\n\u251c\u2500\u2500 cleanup\n\u251c\u2500\u2500 destroy\n\u251c\u2500\u2500 syntax\n\u251c\u2500\u2500 create\n\u251c\u2500\u2500 prepare  # Bring host to testable status.\n\u251c\u2500\u2500 converge  # Required - apply role to test.\n\u251c\u2500\u2500 idempotence\n\u251c\u2500\u2500 side_effect\n\u251c\u2500\u2500 verify  # Assert role is correct.\n\u251c\u2500\u2500 cleanup\n\u2570\u2500\u2500 destroy</code></pre> Reference:<p></p> <ul> <li>https://ansible.readthedocs.io/projects/molecule/getting-started/#inspecting-the-moleculeyml</li> <li>https://sbarnea.com/slides/molecule/#/13</li> </ul>"},{"location":"test_environments/molecule/best_practices/","title":"Best Practices","text":""},{"location":"test_environments/molecule/best_practices/#best-practices","title":"Best Practices","text":"<p>Each pattern requires a separate molecule test setup.</p>"},{"location":"test_environments/molecule/best_practices/#test-patterns","title":"Test Patterns","text":"<ul> <li>Do NOT re-test encapsulated roles and collections.</li> <li> <p>Focus on testing all options and code paths. A component may test   many options if they can be individually explicitly verified.</p> <p>Use Decisions</p> <p>Create decisions when explicitly NOT testing a task.</p> </li> <li> <p>Use least privilege. Comments are required when using these features in   Molecule.</p> <ul> <li>Skipping <code>idempotent</code> step.</li> <li><code>root</code> or <code>SYS_</code> capabilities.</li> <li><code>gather_facts: true</code>.</li> </ul> </li> <li>Roles should be thoroughly tested with VMs for tasks not covered in   containers.</li> <li>Molecule test name reflects component tested.</li> <li> <p>All tests must pass with <code>molecule test --all</code>.</p> <p>Require Enablement</p> <p>Live testing (e.g. external API use) requires explicit enablement (See example).</p> <p>Live testing should always occur before submitting changes if code paths were affected.</p> </li> <li> <p>Make use of Molecule test variables</p> </li> </ul>"},{"location":"test_environments/molecule/best_practices/#moleculeyml","title":"molecule.yml","text":"<ul> <li>Describe test.</li> <li>Define test variables for test setup.</li> </ul>"},{"location":"test_environments/molecule/best_practices/#convergeyml","title":"converge.yml","text":"<ul> <li>unsafe variables must be defined here.   Reference.</li> <li>Edge cases outside of the base setup (e.g.   multiple convergence steps).</li> <li>Use mock scripts to replace binaries when binaries cannot be used in a   container and they do not affect testing (See example).</li> <li>Do live testing here (See example).<ul> <li>Use <code>{ROLE}_testing_enable</code>.</li> <li>Disable live API testing by default to ensure all tests pass.</li> <li>Disable live API usage (which cannot be mocked easily).</li> </ul> </li> </ul>"},{"location":"test_environments/molecule/best_practices/#prepareyml","title":"prepare.yml","text":"<ul> <li>Generate static testing data (certs, keys, network) (See   example).</li> <li>Cache generated files in molecule directory:     <pre><code>'{{ lookup(\"env\", \"MOLECULE_PROJECT_DIRECTORY\") ~ \"/molecule/cache\" }}'</code></pre></li> <li>Cache runtime test files in /tmp on remote host.</li> <li>Specify dynamic target files (See   example).</li> <li>Load generated files and inject in <code>converge.yml</code> (See   example).</li> </ul>"},{"location":"test_environments/molecule/best_practices/#verifyyml","title":"verify.yml","text":"<ul> <li>Use <code>ansible.builtin.assert</code> to validate test results. Any tests missing   assert are not explicitly validating correctness.</li> </ul> <p>Reference:</p> <ul> <li>https://www.puppeteers.net/blog/ansible-quality-assurance-part-1-ansible-variable-validation-with-assert/</li> </ul>"},{"location":"test_environments/molecule/best_practices/#documenting-tests","title":"Documenting Tests","text":"<p>Explicitly state test conditions in <code>molecule.yml</code> using the following format:</p> <pre><code>###############################################################################\n# [Molecule Test Name]\n###############################################################################\n# Description of the molecule test / setup.\n#\n# Tests:\n# * Each condition to verify on completion.</code></pre>"},{"location":"test_environments/molecule/best_practices/#default","title":"Default","text":"<p><code>default</code> is effectively an role integration test with default values - only disabling components which cannot be tested on testing platform - to validate no runtime errors.</p> <p>converge.yml </p><pre><code>- name: 'Converge | default role settings'\n  ansible.builtin.include_role:\n    name: 'r_pufky.deb.os'</code></pre><p></p>"},{"location":"test_environments/molecule/best_practices/#regression","title":"Regression","text":"<p>Explicitly test major bugs to ensure bug is fixed.</p> <ul> <li>Prefix test with regression_.</li> <li>Reference bug in <code>verify.yml</code> with detailed information on cause and   resolution.</li> </ul>"},{"location":"test_environments/molecule/best_practices/#assertions","title":"Assertions","text":"<p>Clearly state expected results and failure reasons (See example).</p>"},{"location":"test_environments/molecule/best_practices/#simple-assertion-failure","title":"Simple assertion failure","text":"<pre><code>- name: 'Verify | script files | assert scripts'\n  ansible.builtin.assert:\n    quiet: true\n    that:\n      - _test_nzbget_skel.files | length == 2\n    fail_msg: |\n      \u256d\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256e\n      \u2502                                                                   \u2502\n      \u2502     /var/lib/nzbget/scripts{scan,post_processing} not found.      \u2502\n      \u2502                                                                   \u2502\n      \u2570\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256f</code></pre>"},{"location":"test_environments/molecule/best_practices/#complex-error-with-variables","title":"Complex error with variables","text":"<pre><code>- name: 'Verify | expressions | assert nzbget_extensions'\n  ansible.builtin.assert:\n    quiet: true\n    that:\n      - _test_nzbget_config is search('Extensions=scan,post_processing')\n    fail_msg: |\n      \u256d\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256e\n      \u2502                                                                   \u2502\n      \u2502                nzbget_extensions format incorrect.                \u2502\n      \u2502                                                                   \u2502\n      \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256f\n      \u2502 Expected:\n      \u2502   Extensions=scan,post_processing\n      \u2502\n      \u2502 _test_nzbget_config: {{ _test_nzbget_config }}</code></pre>"},{"location":"test_environments/molecule/testing/","title":"Testing","text":""},{"location":"test_environments/molecule/testing/#testing","title":"Testing","text":"<p>Prerequisites</p> <ul> <li>Ansible Environment.</li> <li>Podman - Primary test framework.</li> <li>Vagrant - Secondary test framework.</li> <li>Molecule Setup.</li> </ul>"},{"location":"test_environments/molecule/testing/#execute-tests","title":"Execute Tests","text":"<p>Manual test steps </p><pre><code>molecule create\nmolecule converge -- -v\nmolecule verify</code></pre><p></p> <p><code>scenario-name</code> may be used in each step to execute non-default scenario.</p> <p>Run through the default scenario or specified scenarios </p><pre><code>molecule test  # Runs default test - always destroy test containers.\nmolecule test --scenario-name=alt_test  # Runs 'alt_test'.</code></pre><p></p> <p>Run through all existing Molecule scenarios </p><pre><code>molecule test\nmolecule test --all\nmolecule test --all -- -v\nmolecule test --all --destroy=never  # Run all tests - keep containers.</code></pre><p></p>"},{"location":"test_environments/molecule/testing/#debug-molecule-state","title":"Debug molecule state","text":"<pre><code>molecule --debug ${COMMAND}  # Enable verbose debugging.</code></pre>"},{"location":"test_environments/molecule/troubleshooting/","title":"Troubleshooting","text":""},{"location":"test_environments/molecule/troubleshooting/#troubleshooting","title":"Troubleshooting","text":"<p>See Podman and Vagrant for framework specific troubleshooting.</p>"},{"location":"test_environments/molecule/troubleshooting/#yaml-files-reverted-on-test-execution","title":"YAML files reverted on test execution","text":"<p>File linking or caching issue with IDE or Molecule.</p> <p>Suspected causes:</p> <ul> <li>SSHFS connection drops.</li> <li>Rebooting while molecule testing instances are running.</li> <li>IDE environment using stale file handle.</li> </ul> <p>Clear all caches and re-open affected file:</p> <ol> <li>CLOSE the file with the issue in the editor and reopen/save. Re-run     tests.</li> <li>Remove all molecule test state from all tested roles. Re-run tests.     <pre><code>for x in $(ls -1); do pushd ${x} &amp;&amp; molecule destroy --all &amp;&amp; popd; done</code></pre></li> <li>Clean out all ansible caches. Re-run tests.     <pre><code>molecule destroy --all\nmolecule reset\nrm -rfv ~/.cache/molecule/*\nrm -rfv /tmp/ansible-tmp*\nrm -rfv /tmp/ansible-cache/*\nrm -rfv ~/.ansible/*\nrm -rfv ~/.ansible_async/*</code></pre></li> </ol>"},{"location":"test_environments/molecule/troubleshooting/#error-could-not-find-or-access","title":"ERROR! Could not find or access","text":"<p>Molecule uses galaxy roles as dependencies when testing.</p> Error <pre><code>ERROR! Could not find or access '.../ansible_collection_srv/roles/{ROLE}/molecule/{TEST}/{TASK_FROM_FILE}.yml on the Ansible Controller.\n\nfatal: [{INSTANCE}]: FAILED! =&gt; {\n    \"changed\": false,\n    \"include\": \"{TASK_FROM_FILE}.yml\",\n    \"reason\": \"Could not find or access '/var/git/ansible_collection_srv/roles/debian/molecule/network/global.yml' on the Ansible Controller.\"\n}</code></pre> <p>Use FQCN </p><pre><code>- name: 'include full role'\n  ansible.builtin.include_role:\n    name: 'r_pufky.deb.os'</code></pre><p></p> <p>Use tasks_from when no other tasks are sourced within </p><pre><code>- name: 'include task from role if there are no additional include_roles'\n  ansible.builtin.include_role:\n    name: 'r_pufky.deb.os'\n    tasks_from: 'optimizations/firmware.yml'</code></pre> Reference:<p></p> <ul> <li>https://github.com/ansible/molecule/issues/3857</li> </ul>"},{"location":"test_environments/molecule/troubleshooting/#error-the-role-role-was-not-found","title":"ERROR! the role '{ROLE}' was not found ...","text":"<p>Molecule uses galaxy roles as dependencies when testing.</p> Error <pre><code>ERROR! the role 'r_pufky.{COLLECTION}.{ROLE}' was not found in ...\n\nThe offending line appears to be:\n\n      ansible.builtin.include_role:\n        name: 'r_pufky.deb.apt'\n              ^ here</code></pre> <p>Force install updated collection </p><pre><code>ansible-galaxy collection build -f\nansible-galaxy collection install {COLLECTION}-X.X.X.tar.gz -f</code></pre><p></p>"},{"location":"test_environments/molecule/troubleshooting/#critical-idempotence-test-failed-because-of-the-following-tasks","title":"CRITICAL Idempotence test failed because of the following tasks","text":"<p>Not all operations are idempotent.</p> <p>Explicitly disable when idempotence cannot be guaranteed molecule.yml </p><pre><code>scenario:\n  test_sequence:\n    # - 'idempotence'  # Reason for disable.</code></pre><p></p>"},{"location":"test_environments/molecule/troubleshooting/#gathering-facts-failed","title":"Gathering Facts failed","text":"<p>Leftover state from previous or interrupted test.</p> Error <pre><code>TASK [Gathering Facts] *********************************************************\nfatal: [{HOST}]: UNREACHABLE! =&gt; {\"changed\": false, \"msg\": \"Failed to create temporary directory. In some cases, you may have been able to authenticate and did not have permissions on the target</code></pre>"},{"location":"test_environments/molecule/troubleshooting/#destroy-and-re-create","title":"Destroy and re-create","text":"<pre><code>molecule destroy --all</code></pre> <p><code>molecule reset</code> resets internal molecule cache without destroying containers.</p>"},{"location":"test_environments/podman/","title":"Podman Setup","text":""},{"location":"test_environments/podman/#podman-setup","title":"Podman Setup","text":"<p>Prerequisites</p> <ul> <li>Ansible Environment.</li> </ul> <p>Default Testing Platform</p> <p>Rootless podman environment is used to test all cases unless there are required bare-metal cases (See Vagrant).</p>"},{"location":"test_environments/podman/#install","title":"Install","text":"<pre><code>source ansible.env  # source {VENV}/bin/activate\npip install molecule-plugins[Podman]\npacman -Syu crun  # OCI implementation (faster, less memory than runc).\npacman -Syu podman  # Service testing (non kernel, sysctl, networking, etc).</code></pre> <p>Verify Rootless Support. (1)</p> <ol> <li>overlay and Diff: \"true\" mean supported.</li> </ol> <pre><code>podman info | grep -i overlay\n\n&gt; 107:  graphDriverName: overlay\n&gt; 114:    Native Overlay Diff: \"true\"</code></pre> <p>Verify Unprivileged User Namespace Enabled. (1)</p> <ol> <li>1 means enabled.</li> </ol> <pre><code>sysctl kernel.unprivileged_userns_clone\n\n&gt; kernel.unprivileged_userns_clone = 1</code></pre> <p>Create Subordinate UID/GID Mappings. (1)</p> <ol> <li>Configuration entry must exist for each user that wants to use it. New users    created using useradd have these entries by default. If not add user    defaults.</li> </ol> <p></p><pre><code># Add user\ncat /etc/subuid | grep -ri {USER}\n&gt; {USER}:100000:65536\n\n# Add group\ncat /etc/subgid | grep -ri {GROUP}\n&gt; {GROUP}:100000:65536\n\n# Modern linux distros may use this\nusermod --add-subuids 100000-165535 --add-subgids 100000-165535 {USER}</code></pre> Reference:<p></p> <ul> <li>https://github.com/ansible-community/molecule-podman</li> <li>https://github.com/systemd/systemd/issues/21952</li> </ul>"},{"location":"test_environments/podman/#set-default-container-registry","title":"Set Default Container Registry","text":"<p>/etc/containers/registries.conf (1)</p> <ol> <li>0644 root:root</li> </ol> <pre><code>[registries.search]\nregistries = ['ghcr.io']\nunqualified-search-registries=['ghcr.io']</code></pre> <pre><code>podman login ghcr.io  # github account.</code></pre> <p>Required</p> <p>GHCR.IO requires a github login to download images.</p> <p>Reference:</p> <ul> <li>https://halukkarakaya.medium.com/how-to-configure-default-search-registries-in-podman-ea930289692</li> </ul>"},{"location":"test_environments/podman/#migrate-podman-installation","title":"Migrate Podman Installation","text":"<p>Applies configuration changes to Podman. Critical for unprivileged podman to execute properly.</p> <p>Run as the current user. </p><pre><code>podman system reset\npodman system migrate</code></pre> Reference:<p></p> <ul> <li>https://github.com/containers/podman/issues/12715</li> </ul>"},{"location":"test_environments/podman/#set-alternative-container-storage-location-optional","title":"Set alternative container storage location (optional)","text":"<p>Developing on containers will thrash disk especially when running molecule. Relocate high-use directories to a disk that can handle high wear. Prefer to config change as this enables quick use without configuration changes.</p> <p>graphroot and runroot are ignored in rootless containers</p> <p><code>graphroot</code> and <code>runroot</code> are ignored in rootless containers and use following defaults if not defined: </p><pre><code>XDG_CONFIG_HOME=${HOME}/.config\nXDG_DATA_DIR=${HOME}/.local/share\nXDG_RUNTIME_DIR=/run/user/${UID}</code></pre><p></p> <p>Move and link user directories to an alternative location. (1)</p> <ol> <li>Consider moving and linking entire .cache directory.</li> </ol> <p></p><pre><code># delete or move existing cache data.\n# rootless relocation\nls -s /mnt/cache/local/share/containers ${HOME}/.local/share/containers  # graph.\nln -s /mnt/cache/cache/containers ${HOME}/.cache/containers  # config.\n# podman relocation\nln -s /hdd/cache/storage /var/lib/containers/storage  # graph.</code></pre> Reference:<p></p> <ul> <li>https://github.com/containers/podman/blob/main/docs/tutorials/rootless_tutorial.md#user-configuration-files</li> </ul>"},{"location":"test_environments/podman/#references","title":"References","text":"<ul> <li>https://www.ansible.com/blog/developing-and-testing-ansible-roles-with-molecule-and-podman-part-1/</li> <li>https://wiki.archlinux.org/title/Podman</li> </ul>"},{"location":"test_environments/podman/testing/","title":"Testing","text":""},{"location":"test_environments/podman/testing/#testing","title":"Testing","text":"<p>Use podman as it is a full systemd container and does not have many of the issues (including network issues) that docker does.</p> <p>Prerequisites</p> <ul> <li>Ansible Environment.</li> <li>Podman - Primary test framework.</li> </ul>"},{"location":"test_environments/podman/testing/#system-images-used","title":"System Images Used","text":"<ul> <li>https://ghcr.io/hifis-net/debian-systemd:13</li> </ul>"},{"location":"test_environments/podman/testing/#molecule-setup","title":"Molecule Setup","text":"<p>Standard molecule setup for rootless podman debian container.</p> <p>molecule.yml (1)</p> <ol> <li>0644 {USER}:{USER}</li> </ol> <p></p><pre><code>---\ndependency:\n  name: 'galaxy'\ndriver:\n  name: 'podman'\nprovisioner:\n  name: 'ansible'\n  config_options:\n    defaults:\n      interpreter_python: 'auto_silent'  # Suppress warnings.\n      callback_whitelist: 'profile_tasks, timer, yaml'  # Display profiling.\n      # To cache facts between molecule steps:\n      #   fact_caching: 'jsonfile'\n      #   fact_caching_connection: '/tmp/facts_cache'\n      #   fact_caching_timeout: 7200\n      #\n      # cache a fact between steps:\n      #   ansible.builtin.set_fact:\n      #     cacheable: yes\n      #     my_fact: \"howdy, world\"\n      #\n      # always assert cache is not expired before using and document with args:\n      #   - name: 'assert fact_caching not expired'\n      #     ansible.builtin.assert:\n      #       that:\n      #         - '_test_cached_fact is defined'\n      #       fail_msg: 'fact_caching has expired; re-run prepare.'\n    ssh_connection:\n      pipelining: false  # Does not work with podman.\n  # inventory:  # Set all base testing configuration here.\n  #   group_vars:\n  #     all:\n  #       setup_variables: true\n  #   host_vars:\n  #     {IMAGE}-{TEST}:\n  #       setup_variables: true\nplatforms:\n  - name: '{ROLE}-{IMAGE}-{MOLECULE}[-{TEST}]'  # debian-debian-12-default.\n    image: 'ghcr.io/hifis-net/debian-systemd:12'\n    systemd: 'always'\n    volumes:\n      - '/sys/fs/cgroup:/sys/fs/cgroup:ro'\n    # capabilities:  # Always comment explicit need (file, command, etc).\n    #   - 'SYS_ADMIN'  # Required for systemd systems.\n    #   - 'NET_ADMIN'  # Required for network-based testing.\n    command: '/lib/systemd/systemd'\n    pre_build_image: true\n    # privileged: true  # For some operations like sysctl, ulimit.\n    published_ports:\n      - '3000:3000/tcp'  # Exposes port to host. Not needed for testing.\nverifier:\n  name: 'ansible'\nlint: |\n  set -e\n  yamllint .\n  ansible-lint .\n# Disable testing steps as needed with explicit reasons to minimize warnings.\nscenario:\n  test_sequence:\n    - 'dependency'\n    - 'cleanup'\n    - 'destroy'\n    - 'syntax'\n    - 'create'\n    - 'prepare'\n    - 'converge'\n    - 'idempotence'\n    - 'side_effect'\n    - 'verify'\n    - 'cleanup'\n    - 'destroy'</code></pre> Reference:<p></p> <ul> <li>https://ansible.readthedocs.io/projects/molecule/guides/systemd-container/</li> <li>https://ansible.readthedocs.io/projects/molecule/examples/podman/</li> <li>https://ansible.readthedocs.io/projects/molecule/configuration/?h=test_sequence#scenario</li> <li>https://stackoverflow.com/questions/65350229/how-do-i-share-variables-facts-between-molecule-playbooks</li> </ul>"},{"location":"test_environments/podman/troubleshooting/","title":"Troubleshooting","text":""},{"location":"test_environments/podman/troubleshooting/#troubleshooting","title":"Troubleshooting","text":"<p>See molecule for specific molecule troubleshooting.</p>"},{"location":"test_environments/podman/troubleshooting/#driver-podman-does-not-provide-a-schema","title":"Driver podman does not provide a schema","text":"<p>Podman driver does have a schema and will always generate a warning.</p> Error <pre><code>WARNING Driver podman does not provide a schema.</code></pre> <p>Reference:</p> <ul> <li>https://github.com/ansible/molecule/discussions/4108</li> </ul>"},{"location":"test_environments/podman/troubleshooting/#podman-requires-tmpfs-as-dict-not-list","title":"Podman requires 'tmpfs' as dict not list","text":"<p>Molecule documentation refers to using tmpfs as a list. Podman only accepts dictionaries.</p> <p>molecule.yml </p><pre><code>platforms:\n  - name: 'tmpfs as a dict'\n    image: ghcr.io/hifis-net/debian-systemd:13\n    tmpfs:\n      /tmp: 'rw,size=787448k,mode=1777'\n\nplatforms:\n  - name: 'tmpfs not needed with systemd always'\n    image: 'ghcr.io/hifis-net/debian-systemd:13'\n    systemd: 'always'  # tmpfs not need if 'always'.</code></pre> Reference:<p></p> <ul> <li> <p>https://docs.ansible.com/ansible/latest/collections/containers/podman/podman_container_module.html#parameter-tmpfs</p> </li> <li> <p>https://github.com/ansible/molecule/issues/4140</p> </li> </ul>"},{"location":"test_environments/podman/troubleshooting/#podman-database-static-dir-mis-match","title":"Podman database static dir mis-match","text":"<p>Podman will not migrate things out of <code>/home</code> to prevent existing pod breakage.</p> Error <pre><code>Error: database static dir \".../graph/libpod\" does not match our static dir \".../graph/libpod\": database configuration mismatch</code></pre> <p>Reset podman and migrate </p><pre><code>podman system reset\npodman system migrate</code></pre> Reference:<p></p> <ul> <li>https://github.com/containers/podman/pull/20874</li> </ul>"},{"location":"test_environments/podman/troubleshooting/#cannot-use-ping-from-container","title":"Cannot use <code>ping</code> from container","text":"<p>Some containers services require ping.</p> <p>Set system-wide:</p> <p>/etc/sysctl.d/net_ipv4_ping_group_range (1)</p> <ol> <li>0755 root:root</li> </ol> <pre><code>net.ipv4.ping_group_range=0 $MAX_UID</code></pre> <p>Alternatively set during container execution:</p> <p>/etc/containers/containers.conf (1)</p> <ol> <li>0644 root:root`</li> </ol> <p></p><pre><code>default_sysctls = [\n  \"net.ipv4.ping_group_range=0 2147483647\",\n]</code></pre> Reference:<p></p> <ul> <li>https://github.com/containers/podman/blob/main/troubleshooting.md#5-rootless-containers-cannot-ping-hosts</li> </ul>"},{"location":"test_environments/vagrant/","title":"Vagrant Setup","text":""},{"location":"test_environments/vagrant/#vagrant-setup","title":"Vagrant Setup","text":"<p>Prerequisites</p> <ul> <li>Ansible Environment.</li> <li>VirtualBox.</li> </ul> <p>Explicit Need Only</p> <p>Vagrant VMs are ONLY used to test cases which cannot be tested in containers (kernel, firmware, proc, systemd, networking, etc) these should never be default test cases.</p>"},{"location":"test_environments/vagrant/#install","title":"Install","text":"<pre><code>source {VENV}/bin/activate\npamac install vagrant\npip install molecule-plugins[Vagrant]</code></pre> Reference: <ul> <li>https://wiki.archlinux.org/title/Vagrant</li> </ul>"},{"location":"test_environments/vagrant/#set-alternative-storage-location-optional","title":"Set alternative storage location (optional)","text":"<p>Developing on vagrant will thrash disk especially when running molecule with large (multi-GB) reads and writes. Relocate high-use directories to a disk that can handle high wear. Prefer to config change as this enables quick use without configuration changes.</p> <p>Move and link user directories to an alternative location (1)</p> <ol> <li>Consider moving and linking entire <code>.cache</code> directory.</li> </ol> <pre><code># delete or move existing cache data.\nls -s /mnt/cache/local/share/containers ${HOME}/.local/share/containers</code></pre>"},{"location":"test_environments/vagrant/manual_vm/","title":"Manual VM Creation","text":""},{"location":"test_environments/vagrant/manual_vm/#manual-vm-creation","title":"Manual VM Creation","text":"<p>Prerequisites</p> <ul> <li>Ansible Environment.</li> <li>VirtualBox.</li> <li>Vagrant.</li> </ul> <p>Extreme Circumstances Only</p> <p>Where full hardware virtualization and manual input are needed to test (e.g. secure boot requiring manual steps). Explicit reasons for using this test framework MUST BE clearly documented in <code>molecule.yml</code>.</p> <p>These cannot be automated and should always be flag protected. Test should pass without flag to ensure <code>molecule test --all</code> executes without failure.</p>"},{"location":"test_environments/vagrant/manual_vm/#system-images-used","title":"System Images Used","text":"<ul> <li>debian netinstall iso</li> </ul>"},{"location":"test_environments/vagrant/manual_vm/#create-vm","title":"Create VM","text":"<p>Use vagrant-like configuration to maintain similarities with other VM tests. Always use absolute paths as some options do not resolve paths.</p>"},{"location":"test_environments/vagrant/manual_vm/#create-and-list-vm","title":"Create and list VM","text":"<pre><code>mkdir /home/${USER}/VirtualBox VMs/debian-12-efi-template\nvboxmanage list ostypes\nvboxmanage createvm \\\n  --basefolder '/home/${USER}/VirtualBox VMs/debian-12-efi-template' \\\n  --ostype debian12_64 \\\n  --default \\\n  --register \\\n  --name 'debian-12-efi-template'\nvboxmanage list vms\nexport UUID={UUID}  # Always reference with UUID.\nvboxmanage showvminfo ${UUID}</code></pre>"},{"location":"test_environments/vagrant/manual_vm/#use-bridged-networking-if-needed","title":"Use bridged networking (if needed)","text":"<pre><code>vboxmanage modifyvm ${UUID} --nic1 bridged\nvboxmanage modifyvm ${UUID} --bridgeadapter1 {DEVICE}  # Host linux device.</code></pre> Reference: <ul> <li>https://forums.virtualbox.org/viewtopic.php?t=78292</li> </ul>"},{"location":"test_environments/vagrant/manual_vm/#enable-uefi-and-load-certificates","title":"Enable UEFI and load certificates","text":"<pre><code># enable EFI. alternatives: efi, efi32.\nvboxmanage modifyvm ${UUID} --cpus 2 --memory 4096 --firmware efi64\nvboxmanage modifynvram $UUID inituefivarstore  # Reset NVRAM state.\n# Load default MS KEK/DB signatures for secure boot.\nvboxmanage modifynvram $UUID enrollmssignatures\n# Enable default platform keys for secure boot.\nvboxmanage modifynvram $UUID enrollorclpk</code></pre> Reference: <ul> <li>https://www.virtualbox.org/manual/UserManual.html#vboxmanage-modifynvram</li> </ul>"},{"location":"test_environments/vagrant/manual_vm/#secure-boot-toggle","title":"Secure Boot Toggle","text":"<p>Secure boot state cannot be changed with <code>mokutil</code> in VM; explicitly set state to disabled for base testing and enable when needing to test final state.</p> <pre><code>vboxmanage modifynvram $UUID secureboot --disable</code></pre>"},{"location":"test_environments/vagrant/manual_vm/#attach-storage","title":"Attach Storage","text":"<pre><code>vboxmanage createmedium \\\n  disk --size 6000 \\\n  --format vdi \\\n  --filename '/home/${USER}/VirtualBox VMs/debian-12-efi-template/disk.vdi'\nvboxmanage storageattach ${UUID} \\\n  --storagectl 'SATA' \\\n  --device 0 \\\n  --port 1 \\\n  --type hdd \\\n  --medium '/home/${USER}/VirtualBox VMs/debian-12-efi-template/disk.vdi'\nvboxmanage storageattach ${UUID} \\\n  --storagectl 'SATA' \\\n  --port 2 \\\n  --type dvddrive \\\n  --medium '/home/${USER}/debian-12.8.0-amd64-netinst.iso'</code></pre>"},{"location":"test_environments/vagrant/manual_vm/#start-vm","title":"Start VM","text":"<pre><code>vboxmanage startvm ${UUID}</code></pre> Reference: <ul> <li>https://docs.oracle.com/en/virtualization/virtualbox/6.0/user/efi.html</li> </ul>"},{"location":"test_environments/vagrant/manual_vm/#base-os-install","title":"Base OS Install","text":"<ul> <li>Hostname: debian</li> <li>Domain: {EMPTY}</li> <li>users (password):<ul> <li>root (vagrant)</li> <li>vagrant (vagrant)</li> </ul> </li> <li>guided partition:<ul> <li>whole disk</li> <li>one partition</li> <li>overwrite</li> </ul> </li> <li>packages:<ul> <li>ssh</li> <li>standard system utilities</li> </ul> </li> </ul> <p>Reboot once complete.</p>"},{"location":"test_environments/vagrant/manual_vm/#install-vagrant-ssh-keys","title":"Install vagrant SSH keys","text":"<pre><code>wget https://raw.githubusercontent.com/hashicorp/vagrant/refs/heads/main/keys/vagrant.pub -O /root/.ssh/authorized_keys</code></pre> Reference: <ul> <li>https://github.com/hashicorp/vagrant/tree/main/keys</li> </ul>"},{"location":"test_environments/vagrant/manual_vm/#zero-disk-and-clear-history","title":"Zero disk and clear history","text":"<p>Enables high compression when imaged and a clean system state.</p> <p></p><pre><code>apt get clean\ndd if=/dev/zero of=/EMPTY bs=1M\nrm -f /EMPTY\ncat /dev/null &gt; ~/.bash_history &amp;&amp; history -c &amp;&amp; exit</code></pre> Reference:<p></p> <ul> <li>https://gist.github.com/srijanshetty/86aa6540d27736c1c11b</li> </ul>"},{"location":"test_environments/vagrant/manual_vm/#shutdown-and-image-vm","title":"Shutdown and Image VM","text":"<pre><code>VBoxManage controlvm ${UUID} acpipowerbutton\n# Backup virtualbox image pristine w/ disk.\nvboxmanage export ${UUID} --output exported-debian-12-efi.ovf --ovf20</code></pre> Reference: <ul> <li>https://www.engineyard.com/blog/building-a-vagrant-box-from-start-to-finish/</li> <li>https://andreafortuna.org/2019/10/24/how-to-create-a-virtualbox-vm-from-command-line/</li> </ul>"},{"location":"test_environments/vagrant/manual_vm/#manually-export-image-and-import-into-vagrant","title":"Manually export image and import into vagrant","text":"<p>Export machine for vagrant use. Does not enable automatic VM load unless image is also published.</p> <pre><code>vagrant package --base ${UUID} --output ucs.box  # Template VM UUID.\n# Use 'vagrant-debian' in molecule tests.\nvagrant box add ucs.box --name vagrant-debian</code></pre>"},{"location":"test_environments/vagrant/manual_vm/#manual-vm-molecule-setup","title":"Manual VM Molecule Setup","text":"<p>Standard Molecule setup for manual VM (see Molecule).</p>"},{"location":"test_environments/vagrant/manual_vm/#copy-vagrant-ssh-keys","title":"Copy vagrant SSH keys","text":"<p>Vagrant SSH keys are published here.</p> <ul> <li><code>molecule/id.{pub,key}</code> for use in all molecule tests.</li> <li><code>molecule/{TEST}/id.{pub,key}</code> for specific molecule tests.</li> </ul>"},{"location":"test_environments/vagrant/manual_vm/#set-restricted-permissions","title":"Set restricted permissions","text":"<p>Molecule will fail SSH connections and not mention permissions issues.</p> <pre><code>chmod 0400 id.*</code></pre> <p>molecule.yml (1)</p> <ol> <li>0644 {USER}:{USER}</li> </ol> <pre><code>provisioner:\n  inventory:\n    group_vars:\n      all:\n        ansible_ssh_user: 'root'  # Molecule users logged in user by default.\n        ansible_ssh_private_key_file:\n          '{{ lookup(\"env\", \"MOLECULE_PROJECT_DIRECTORY\") }}/molecule/id.key'\n        # For key only in test location.\n        # ansible_ssh_private_key_file:\n        #   '{{ lookup(\"env\", \"MOLECULE_EPHEMERAL_DIRECTORY\") }}/id.key'\nplatforms:\n  - name: '192.168.1.10'  # VM IP.</code></pre> <p>create.yml (1)</p> <p>This is an exact copy of default create with provisioning disabled.</p> <ol> <li>0644 {USER}:{USER}</li> </ol> <p></p><pre><code>---\n- name: 'Create'\n  hosts: 'localhost'\n  connection: 'local'\n  gather_facts: false\n  tasks:\n    - name: 'Create | molecule inventory'\n      ansible.builtin.debug:\n        msg: skipping provisioning\n\n    - name: 'Create | populate instance config'\n      ansible.builtin.set_fact:\n        instance_conf_dict: {'instance': '{{ item.name }}'}\n      loop: '{{ molecule_yml.platforms }}'\n      register: instance_config_dict</code></pre> Reference:<p></p> <ul> <li>https://medium.com/@fabio.marinetti81/validate-ansible-roles-through-molecule-delegated-driver-a2ea2ab395b5</li> <li>https://cloudautomation.pharriso.co.uk/post/molecule-vm-create/#:~:text=Molecule%20Configuration,yml</li> </ul>"},{"location":"test_environments/vagrant/testing/","title":"Testing","text":""},{"location":"test_environments/vagrant/testing/#testing","title":"Testing","text":"<p>Prerequisites</p> <ul> <li>Ansible Environment.</li> <li>VirtualBox.</li> <li>Vagrant.</li> </ul>"},{"location":"test_environments/vagrant/testing/#system-images-used","title":"System Images Used","text":"<p>Licensing</p> <p>Debian team has stopped creating official images due to licensing issues with hashicorp.</p> <ul> <li>inception-of-things/trixie</li> <li> <p>boxen/debian-13 (1)</p> <ol> <li>Alternate - currently SSH key build issues.</li> </ol> </li> </ul>"},{"location":"test_environments/vagrant/testing/#image-repositories","title":"Image repositories","text":"<ul> <li>https://portal.cloud.hashicorp.com/vagrant/discover/</li> <li>https://www.osboxes.org/debian/</li> </ul> <p>Alternatively a non-maintained Debian image may be created.</p>"},{"location":"test_environments/vagrant/testing/#molecule-setup","title":"Molecule Setup","text":"<p>Standard molecule setup for vagrant with virtualbox VM.</p> <p>molecule.yml (1)</p> <ol> <li>0644 {USER}:{USER}</li> </ol> <p></p><pre><code>---\ndependency:\n  name: 'galaxy'\ndriver:\n  name: 'vagrant'\n  provider:\n    name: 'virtualbox'\n    enable_efi: true\n    # provider_raw_config_args:\n    #   - \"customize [ 'modifyvm', :id, '--firmware', 'efi' ]\"\n    config_options:\n      ssh.keep_alive: true\n      ssh.remote_user: 'root'  # Vagrant login user (check VM image).\n    options:\n      append_platform_to_hostname: false\nprovisioner:\n  name: 'ansible'\n  config_options:\n    defaults:\n      interpreter_python: 'auto_silent'  # Suppress warnings.\n      callback_whitelist: 'profile_tasks, timer, yaml'  # Display profiling.\n  # inventory:  # Set all base testing configuration here.\n  #   group_vars:\n  #     all:\n  #       setup_variables: true\n  #   host_vars:\n  #     {IMAGE}-{TEST}:\n  #       setup_variables: true\nplatforms:\n  - name: '{ROLE}-{IMAGE}-vm-{TEST}'\n    box: 'inception-of-things/trixie'\n    memory: 4096\n    cpus: 2\n    interfaces:\n      - network_name: 'private_network'  # Required.\n        auto_config: true\n        type: 'dhcp'\n        # type: static\n        # ip: 192.168.56.10  # default is 192.168.56.0/21\n    instance_raw_config_args:\n      - 'vm.network \"forwarded_port\", guest: 8443, host: 8443'\n      - 'vm.network \"forwarded_port\", guest: 8080, host: 8080'\n      - 'vm.network \"forwarded_port\", guest: 8880, host: 8880'\n      - 'vm.network \"forwarded_port\", guest: 8443, host: 8843'\nverifier:\n  name: 'ansible'\n# Disable testing steps as needed with explicit reasons to minimize warnings.\nscenario:\n  test_sequence:\n    - 'dependency'\n    - 'cleanup'\n    - 'destroy'\n    - 'syntax'\n    - 'create'\n    - 'prepare'\n    - 'converge'\n    - 'idempotence'\n    - 'side_effect'\n    - 'verify'\n    - 'cleanup'\n    - 'destroy'</code></pre> Reference:<p></p> <ul> <li>https://ansible.readthedocs.io/projects/molecule/configuration/?h=test_sequence#scenario</li> <li>https://floatingpoint.sorint.it/blog/post/setting-up-molecule-for-testing-ansible-roles-with-vagrant-and-testinfra</li> </ul> <p>converge.yml (1)</p> <ol> <li>0644 {USER}:{USER}</li> </ol> <p></p><pre><code>- name: 'Molecule testing step'\n  hosts: 'all'\n  gather_facts: false\n  # Always **become** ssh.remote_user when creating Molecule tests or setup an\n  # ansible user after VM turnup to apply ansible tasks.\n  become: true</code></pre> Reference:<p></p> <ul> <li>https://stackoverflow.com/questions/33563425/ansible-1-9-4-failed-to-lock-apt-for-exclusive-operation</li> </ul>"},{"location":"test_environments/vagrant/troubleshooting/","title":"Troubleshooting","text":""},{"location":"test_environments/vagrant/troubleshooting/#troubleshooting","title":"Troubleshooting","text":""},{"location":"test_environments/vagrant/troubleshooting/#driver-vagrant-does-not-provide-a-schema","title":"Driver vagrant does not provide a schema","text":"<p>Vagrant driver does have a schema and will always generate a warning.</p> Error <pre><code>WARNING Driver vagrant does not provide a schema.</code></pre> <p>Reference:</p> <ul> <li>https://github.com/ansible/molecule/discussions/4108</li> </ul> <p>Reference discussion lost in ansible consolidation to https://forum.ansible.com.</p>"},{"location":"test_environments/vagrant/troubleshooting/#a-vagrant-environment-or-target-machine-is-required-to-run-this-command","title":"A Vagrant environment or target machine is required to run this command","text":"<p>Virtualbox kernel modules are likely not loaded.</p> Error <pre><code>A Vagrant environment or target machine is required to run this\ncommand. Run 'vagrant init' to create a new Vagrant environment. Or,\nget an ID of a target machine from 'vagrant global-status' to run\nthis command on. A final option is to change to a directory with a\nVagrantfile and to try again.</code></pre> <p>Install kernel modules. </p><pre><code>mhwd-kernel -l\npamac install linux{KERNEL}-virtualbox-host-modules\nsystemctl reboot</code></pre><p></p> <p>Confirm each command works. </p><pre><code>vboxmanage --version  # Executable with modules loaded.\n&gt; 7.1.4r165100  # Installed version.\nvagrant global-status\nvagrant up --provider virtualbox  # Provides details why it is not running.</code></pre><p></p>"},{"location":"test_environments/vagrant/troubleshooting/#verr_cfgm_not_enough_space","title":"VERR_CFGM_NOT_ENOUGH_SPACE","text":"<p>Molecule test fails during create due to vagrant path length limitation (see underlying virtualization manager).</p> Error <pre><code>fatal: [localhost]: FAILED! =&gt; {\n    \"changed\": false,\n    \"cmd\": [\n        \"/usr/bin/vagrant\",\n        \"up\",\n        \"--no-provision\"\n    ],\n    \"rc\": 1\n}\n\nSTDERR:\n\n### YYYY-MM-DD 20:32:26 ###\n### YYYY-MM-DD 20:32:26 ###\nThere was an error while executing `VBoxManage`, a CLI used by Vagrant\nfor controlling VirtualBox. The command and stderr is shown below.\n\nCommand: [\"startvm\", \"b3415658-8f60-4026-8375-f6ec52014db5\", \"--type\", \"headless\"]\n\nStderr: VBoxManage: error: Failed to construct device 'ichac97' instance #0 (VERR_CFGM_NOT_ENOUGH_SPACE)\nVBoxManage: error: Details: code NS_ERROR_FAILURE (0x80004005), component ConsoleWrap, interface IConsole\n\nMSG:\n\nFailed to start the VM(s): See log file '.../vagrant.err'</code></pre> <p>Use shorter component names:</p> <ul> <li>VM instance name in <code>molecule.yml</code>.</li> <li>Rename molecule test to shorter name.</li> <li>Extreme cases may require cloning repo with a shorter root repository name.</li> </ul> <p>my_role/molecule/my_test/molecule.yml </p><pre><code>platforms:\n  - name: 'test-case-vm'\n    box: 'inception-of-things/trixie'\n    interfaces:\n      - network_name: 'private_network'</code></pre><p></p> <p>Molecule creates a VM name combining:</p> <ul> <li>Molecule test name (<code>my_test</code>).</li> <li>Molecule image test name (<code>test-case-vm</code>).</li> <li>Image box name (<code>inception-of-things-trixie</code>).</li> <li>OS used (<code>debian</code>).</li> <li>Network (<code>private_network</code>).</li> <li>Random UUID hash (36 characters).</li> </ul>"},{"location":"test_environments/vagrant/troubleshooting/#failed-to-lock-apt-for-exclusive-operation","title":"Failed to lock apt for exclusive operation","text":"<p>Debian VirtualBox VM uses root to configure and test the instance. All Molecule setup/teardown steps require root user.</p> <p></p><pre><code>- name: 'Molecule testing step'\n  hosts: 'all'\n  gather_facts: false\n  # Always **become** ssh.remote_user when creating Molecule tests or setup an\n  # ansible user after VM turnup to apply ansible tasks.\n  become: true</code></pre> Reference:<p></p> <ul> <li>https://stackoverflow.com/questions/33563425/ansible-1-9-4-failed-to-lock-apt-for-exclusive-operation</li> </ul>"},{"location":"test_environments/vagrant/troubleshooting/#failed-to-start-the-vms","title":"Failed to start the VM(s)","text":"<p>Virtualbox may fail due to system constraints.</p> Error <pre><code>PLAY [Create] ******************************************************************\nfatal: [localhost]: FAILED! =&gt; {\n    \"changed\": false,\n    \"cmd\": [\n        \"/usr/bin/vagrant\",\n        \"up\",\n        \"--no-provision\"\n    ],\n    \"rc\": 1\n}\n\nSTDERR:\n\n### YYYY-MM-DD 15:10:23 ###\n### YYYY-MM-DD 15:10:23 ###\n### YYYY-MM-DD 15:10:23 ###\n### YYYY-MM-DD 15:32:14 ###\n### YYYY-MM-DD 15:32:15 ###\n### YYYY-MM-DD 15:32:15 ###\nThe SSH connection was unexpectedly closed by the remote end. This\nusually indicates that SSH within the guest machine was unable to\nproperly start up. Please boot the VM in GUI mode to check whether\nit is booting properly.\n\nMSG:\n\nFailed to start the VM(s): See log file '.../vagrant.err'</code></pre> <p>Re-run test. </p><pre><code>molecule test --scenario-name={TEST}</code></pre><p></p>"},{"location":"test_environments/vagrant/troubleshooting/#flaky-vm","title":"Flaky VM","text":"<p>A previous molecule test likely not cleaned up properly.</p> <p>Clean all VMs and re-run. </p><pre><code>vagrant global-status\nvagrant destroy {ID}\nvagrant box list\nvagrant box destroy {ID}</code></pre><p></p> <p>Tip</p> <p>Check GUI for additional VMs if needed.</p>"},{"location":"test_environments/vagrant/troubleshooting/#error-couldnt-resolve-moduleaction-vagrant","title":"ERROR! couldn't resolve module/action 'vagrant'","text":"<p>Molecule 25.2.0 is a bad release that broke vagrant modules.</p> Error <pre><code>molecule create\n&gt; WARNING  Driver vagrant does not provide a schema.\n&gt; INFO     default scenario test matrix: dependency, create, prepare, converge\n&gt; INFO     Performing prerun with role_name_check=0...\n&gt; INFO     Running default &gt; dependency\n&gt; WARNING  Skipping, missing the requirements file.\n&gt; WARNING  Skipping, missing the requirements file.\n&gt; INFO     Running default &gt; create\n&gt; ERROR! couldn't resolve module/action 'vagrant'. This often indicates a misspelling, missing collection, or incorrect module path.\n&gt;\n&gt; The error appears to be in '.../molecule_plugins/vagrant/playbooks/create.yml': line 8, column 7, but may\n&gt; be elsewhere in the file depending on the exact syntax problem.\n&gt;\n&gt; The offending line appears to be:\n&gt;\n&gt;   tasks:\n&gt;     - name: Create molecule instance(s) # noqa fqcn[action]\n&gt;       ^ here</code></pre> <p>Install Molecule 25.1.0 as a temporary workaround. </p><pre><code>pip install --force-reinstall -v 'molecule==25.1.0'</code></pre> Reference:<p></p> <ul> <li>https://github.com/ansible-community/molecule-plugins/issues/301</li> </ul>"},{"location":"test_environments/vagrant/troubleshooting/#permission-denied-publickeypassword","title":"Permission denied (publickey,password)","text":"<p>Verify permissions are correct and keys are loaded from the correct location. Applies to Manual VM only.</p> Error <pre><code>TASK [Install packages] ********************************************************\nincluded: {ROLE} for 10.2.2.39\nfatal: [10.2.2.39]: UNREACHABLE! =&gt; {\n    \"changed\": false,\n    \"unreachable\": true\n}\nMSG:\nroot@10.2.2.39: Permission denied (publickey,password).</code></pre> <p>Confirm keys are set correctly in VM </p><pre><code>ls -l id.*\n&gt; 0400 {USER}:{USER} id.*</code></pre><p></p> <p>Add debug line in converge to confirm key is located correctly converge.yml </p><pre><code>- ansible.builtin.debug:\n    msg: '{{ ansible_ssh_private_key_file }}'</code></pre><p></p>"},{"location":"test_environments/vagrant/troubleshooting/#vm-moved-or-not-registered","title":"VM moved or not registered","text":"<p>Register VM - VMs must be registered to start in VirtualBox. Applies to Manual VM only.</p> <pre><code>vboxmanage registervm \\\n  /home/{USER}/VirtualBox\\ VMs/debian-12-efi-template/debian-12-efi-template.vbox</code></pre>"},{"location":"test_environments/virtualbox/","title":"VirtualBox Setup","text":""},{"location":"test_environments/virtualbox/#virtualbox-setup","title":"VirtualBox Setup","text":"<p>Prerequisites</p> <ul> <li>Ansible Environment.</li> </ul> <p>Explicit Need Only</p> <p>VirtualBox VMs are ONLY used to test cases which cannot be tested in containers (kernel, firmware, proc, systemd, networking, etc) these should never be default test cases.</p>"},{"location":"test_environments/virtualbox/#install","title":"Install","text":"<pre><code>source {VENV}/bin/activate\npamac install virtualbox  # No additional dependencies.\nmhwd-kernel -l\nmhwd-kernel -li  # Install at least the running kernel.\npamac install linux{VERSION}-virtualbox-host-modules\npip install molecule-plugins[VirtualBox]\ngpasswd -a ${USER} vboxusers  # Add user to virtualbox users.\nsystemctl reboot  # Install extended features first if needed.</code></pre> Reference: <ul> <li>https://wiki.manjaro.org/index.php/VirtualBox</li> </ul> <p>Extended features are only needed for testing USB, webcam, RDP, PXE, disk encryption, or NVMe. </p><pre><code>pamac build virtualbox-ext-oracle\nsystemctl reboot\n\nmodprobe vboxdrv vboxnetadp xvboxnetflt  # Alternate reload without reboot.</code></pre><p></p> <p>Confirm installed. </p><pre><code>vboxmanage --version\n&gt; 7.1.4r165100  # Installed version.</code></pre><p></p>"},{"location":"test_environments/virtualbox/#set-alternative-storage-location-optional","title":"Set alternative storage location (optional)","text":"<p>Developing on VMs will thrash disk especially when running molecule. Relocate high-use directories to a disk that can handle high wear. Prefer to config change as this enables quick use without configuration changes.</p> <p>Move and link user directories to an alternative location (1)</p> <ol> <li>Consider moving and linking entire <code>.cache</code> directory.</li> </ol> <p></p><pre><code># delete or move existing cache data.\nls -s /mnt/cache/config/VirtualBox ${HOME}/.config/VirtualBox  # Config.\nln -s '/mnt/cache/VirtualBox VMs' '${HOME}/VirtualBox VMs'  # VM data.</code></pre> Reference:<p></p> <ul> <li>https://docs.oracle.com/en/virtualization/virtualbox/6.0/admin/vboxconfigdata.html</li> </ul>"},{"location":"test_environments/virtualbox/troubleshooting/","title":"Troubleshooting","text":""},{"location":"test_environments/virtualbox/troubleshooting/#troubleshooting","title":"Troubleshooting","text":""},{"location":"test_environments/virtualbox/troubleshooting/#vboxdrv-kernel-module-is-not-loaded","title":"vboxdrv kernel module is not loaded","text":"<p>Kernel modules are not loaded.</p> Error <pre><code>WARNING: The vboxdrv kernel module is not loaded. Either there is no module\n         available for the current kernel (4.4.0-22-generic) or it failed to\n         load. Please recompile the kernel module and install it by\n\n           sudo /sbin/rcvboxdrv setup\n\n         You will not be able to start VMs until this problem is fixed.</code></pre> <p>Install kernel modules. </p><pre><code>mhwd-kernel -l\npamac install linux{KERNEL}-virtualbox-host-modules\nsystemctl reboot</code></pre><p></p> <p>Confirm installed. </p><pre><code>vboxmanage --version  # Executable with modules loaded.\n&gt; 7.1.4r165100  # Installed version.</code></pre><p></p>"}]}